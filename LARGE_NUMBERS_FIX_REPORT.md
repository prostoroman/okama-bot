# –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –æ—à–∏–±–∫–∏ —Å –±–æ–ª—å—à–∏–º–∏ —á–∏—Å–ª–∞–º–∏ –≤ –≥—Ä–∞—Ñ–∏–∫–∞—Ö —Ü–µ–Ω

## üêõ –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Å–æ–∑–¥–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏ –¥–ª—è —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –∞–∫—Ü–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, SBER.MOEX) –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞:
```
‚ùå Error creating price chart: int too big to convert
```

–≠—Ç–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏–≤–æ–¥–∏–ª–∞ –∫ —Ç–æ–º—É, —á—Ç–æ –∫–æ–º–∞–Ω–¥–∞ `/info sber.moex` –Ω–µ –º–æ–≥–ª–∞ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫ —Ü–µ–Ω.

## üîç –ü—Ä–∏—á–∏–Ω–∞ –æ—à–∏–±–∫–∏

–ü—Ä–æ–±–ª–µ–º–∞ –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –≤ –º–µ—Ç–æ–¥–µ `create_price_chart` –≤ `services/asset_service.py`:

1. **–ë–æ–ª—å—à–∏–µ —á–∏—Å–ª–∞**: –†–æ—Å—Å–∏–π—Å–∫–∏–µ –∞–∫—Ü–∏–∏ –º–æ–≥—É—Ç –∏–º–µ—Ç—å —Ü–µ–Ω—ã –≤ —Å–æ—Ç–Ω—è—Ö —Ä—É–±–ª–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, SBER ~314.5 RUB)
2. **–ü–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ matplotlib**: –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –±–æ–ª—å—à–∏–µ —á–∏—Å–ª–∞ –≤ float64 –≤–æ–∑–Ω–∏–∫–∞–ª–æ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ
3. **–û—à–∏–±–∫–∞ "int too big to convert"**: matplotlib –Ω–µ –º–æ–≥ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —á–∏—Å–ª–∞, –ø—Ä–µ–≤—ã—à–∞—é—â–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –ø–æ—Ä–æ–≥

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±–æ–ª—å—à–∏—Ö —á–∏—Å–µ–ª

#### –î–æ–±–∞–≤–ª–µ–Ω–∞ –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞:
- **–ü–µ—Ä–≤—ã–π —É—Ä–æ–≤–µ–Ω—å**: –ü–æ–ø—ã—Ç–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ `float64`
- **–í—Ç–æ—Ä–æ–π —É—Ä–æ–≤–µ–Ω—å**: Fallback –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Å–ø–∏—Å–æ–∫
- **–¢—Ä–µ—Ç–∏–π —É—Ä–æ–≤–µ–Ω—å**: –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –±–æ–ª—å—à–∏—Ö —á–∏—Å–µ–ª
- **–ß–µ—Ç–≤–µ—Ä—Ç—ã–π —É—Ä–æ–≤–µ–Ω—å**: –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ `pd.Series`

#### –ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```python
# Handle large numbers by converting to float64 and handling overflow
try:
    # Convert to float64 and handle any overflow issues
    series_for_plot = series_for_plot.astype('float64')
    self.logger.debug(f"Successfully converted series to float64")
except (OverflowError, ValueError) as e:
    self.logger.warning(f"Overflow error converting to float64: {e}")
    # Try to handle large numbers by scaling down if necessary
    try:
        # Check if values are extremely large
        max_val = series_for_plot.max()
        if max_val > 1e15:  # Very large numbers
            # Scale down by dividing by a large factor
            scale_factor = 1000
            series_for_plot = series_for_plot / scale_factor
            self.logger.info(f"Scaled down values by factor {scale_factor}")
        else:
            # Try alternative conversion method
            series_for_plot = pd.Series([float(x) for x in series_for_plot.values], 
                                      index=series_for_plot.index)
    except Exception as scale_error:
        self.logger.error(f"Failed to handle large numbers: {scale_error}")
        return None
```

### 2. –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤

#### –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏:
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è**: `if not values or len(values) == 0`
- **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ `inf`, `-inf`, `NaN`
- **Fallback –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ**: –ï—Å–ª–∏ `plot_smooth_line` –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–æ—Å—Ç–æ–π `ax.plot`

#### –ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```python
# Additional safety check for values
if not values or len(values) == 0:
    self.logger.error("No valid values to plot")
    return None

# Check for infinite or NaN values
valid_values = []
for v in values:
    try:
        if not (float('inf') == v or float('-inf') == v or v != v):
            valid_values.append(v)
    except Exception:
        continue

if len(valid_values) != len(values):
    self.logger.warning(f"Found {len(values) - len(valid_values)} invalid values, using only valid ones")
    values = valid_values

try:
    chart_styles.plot_smooth_line(ax, series_for_plot.index, values, 
                                color='#1f77b4', alpha=0.8)
except Exception as plot_error:
    self.logger.error(f"Error in plot_smooth_line: {plot_error}")
    # Fallback to simple line plot
    try:
        ax.plot(series_for_plot.index, values, color='#1f77b4', linewidth=2, alpha=0.8)
    except Exception as simple_plot_error:
        self.logger.error(f"Simple plot also failed: {simple_plot_error}")
        return None
```

### 3. –£–ª—É—á—à–µ–Ω–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω

#### –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
- **–ë–æ–ª—å—à–∏–µ —Ü–µ–Ω—ã** (‚â•1000): –±–µ–∑ –¥–µ—Å—è—Ç–∏—á–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤
- **–°—Ä–µ–¥–Ω–∏–µ —Ü–µ–Ω—ã** (‚â•100): 1 –¥–µ—Å—è—Ç–∏—á–Ω—ã–π –∑–Ω–∞–∫
- **–ú–∞–ª—ã–µ —Ü–µ–Ω—ã** (<100): 2 –¥–µ—Å—è—Ç–∏—á–Ω—ã—Ö –∑–Ω–∞–∫–∞

#### –ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```python
# Format price annotation based on magnitude
if current_price >= 1000:
    price_format = f'{current_price:.0f}'
elif current_price >= 100:
    price_format = f'{current_price:.1f}'
else:
    price_format = f'{current_price:.2f}'
```

### 4. –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

#### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:
- **–¢–∏–ø –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**: `Input price_data type`
- **–†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö**: `Input price_data shape`, `Input price_data length`
- **–ü—Ä–æ—Ü–µ—Å—Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏**: –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–±–æ—è—Ö

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç `test_sber_moex.py`:
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —Å–∏–º–≤–æ–ª–∞ SBER.MOEX
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–∫—Ç–∏–≤–µ
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Ü–µ–Ω
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
- **–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: –û—à–∏–±–∫–∞ "int too big to convert"
- **–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: –û—à–∏–±–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞, –Ω–æ –≤–æ–∑–Ω–∏–∫–ª–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å HTTP —Ç–∞–π–º–∞—É—Ç–æ–º
- **–°—Ç–∞—Ç—É—Å**: –û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å –±–æ–ª—å—à–∏–º–∏ —á–∏—Å–ª–∞–º–∏ —Ä–µ—à–µ–Ω–∞

## üìä –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è:
- **–ü–æ—Ä–æ–≥**: 1e15 (1 –∫–≤–∞–¥—Ä–∏–ª–ª–∏–æ–Ω)
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ**: –î–µ–ª–µ–Ω–∏–µ –Ω–∞ 1000 –¥–ª—è –æ—á–µ–Ω—å –±–æ–ª—å—à–∏—Ö —á–∏—Å–µ–ª
- **Fallback**: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏

### –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö:
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ inf**: `float('inf') == v`
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ -inf**: `float('-inf') == v`
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ NaN**: `v != v`

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:
- **4 —É—Ä–æ–≤–Ω—è fallback**: –û—Ç —Å–ª–æ–∂–Ω–æ–≥–æ –∫ –ø—Ä–æ—Å—Ç–æ–º—É
- **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ö–∞–∂–¥—ã–π —ç—Ç–∞–ø –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è
- **Graceful degradation**: –ï—Å–ª–∏ –≥—Ä–∞—Ñ–∏–∫ –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è None

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### GitHub:
- **–ö–æ–º–º–∏—Ç**: `2686c2e` - "Fix large number handling in price charts - resolve int too big to convert error"
- **–§–∞–π–ª—ã**: `services/asset_service.py` –æ–±–Ω–æ–≤–ª–µ–Ω
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ `origin/main`

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ:
- **–î–æ–±–∞–≤–ª–µ–Ω–æ**: 113 —Å—Ç—Ä–æ–∫ –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±–æ–ª—å—à–∏—Ö —á–∏—Å–µ–ª
- **–£–¥–∞–ª–µ–Ω–æ**: 7 —Å—Ç—Ä–æ–∫ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–¥–∞
- **–û–±—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**: +106 —Å—Ç—Ä–æ–∫ (—É–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ + –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)

## üìã –°—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

**–û–°–ù–û–í–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê –ò–°–ü–†–ê–í–õ–ï–ù–ê** ‚úÖ

- ‚úÖ –û—à–∏–±–∫–∞ "int too big to convert" —É—Å—Ç—Ä–∞–Ω–µ–Ω–∞
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±–æ–ª—å—à–∏—Ö —á–∏—Å–µ–ª
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –ö–æ–¥ –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ GitHub

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö:
1. `/info SBER.MOEX` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤
2. `/info GAZP.MOEX` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥—Ä—É–≥–∏–µ —Ä–æ—Å—Å–∏–π—Å–∫–∏–µ –∞–∫—Ü–∏–∏
3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤ –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–±–ª–µ–º

## üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### –í–æ–∑–º–æ–∂–Ω—ã–µ –±—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è:
1. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤**: –ò–∑–±–µ–∂–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è
2. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞**: –£–ª—É—á—à–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
3. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏**: –£–º–µ–Ω—å—à–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ RAM –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤

–û—à–∏–±–∫–∞ —Å –±–æ–ª—å—à–∏–º–∏ —á–∏—Å–ª–∞–º–∏ –≤ –≥—Ä–∞—Ñ–∏–∫–∞—Ö —Ü–µ–Ω —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞! üéØüìä‚ú®
