#!/usr/bin/env python3
"""
Test script for portfolio AI analysis truncation fix
"""

import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from bot import ShansAi
import asyncio

async def test_portfolio_ai_truncation_fix():
    """Test the portfolio AI analysis truncation fix"""
    print("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–±—Ä–µ–∑–∞–Ω–∏—è AI –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—è")
    print("=" * 60)
    
    # Initialize bot
    bot = ShansAi()
    
    # Create a very long analysis text to test truncation fix
    long_analysis = """
# üìä –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ—Ä—Ç—Ñ–µ–ª—è

## –û–±—â–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ—Ä—Ç—Ñ–µ–ª—è
–í–∞—à –ø–æ—Ä—Ç—Ñ–µ–ª—å –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é —Å —Ö–æ—Ä–æ—à–∏–º —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ–º —Ä–∏—Å–∫-–¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å. 

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:
- **–û–±—â–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å**: 12.5% –≥–æ–¥–æ–≤—ã—Ö
- **–í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å**: 15.2%
- **–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –®–∞—Ä–ø–∞**: 0.82
- **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ—Å–∞–¥–∫–∞**: -8.3%
- **–í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è**: 3.2 –º–µ—Å—è—Ü–∞

## ‚öñÔ∏è –ê–Ω–∞–ª–∏–∑ —Å–æ—Å—Ç–∞–≤–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—è

### –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–æ–≤:
1. **SPY.US (60%)** - –û—Å–Ω–æ–≤–Ω–æ–π –¥—Ä–∞–π–≤–µ—Ä –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏
   - –í–∫–ª–∞–¥ –≤ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å: +7.5%
   - –í–∫–ª–∞–¥ –≤ —Ä–∏—Å–∫: +9.1%
   - –°—Ç–∞—Ç—É—Å: –ü–µ—Ä–µ–≤–µ—Å, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–Ω–∏–∂–µ–Ω–∏–µ –¥–æ 50%

2. **QQQ.US (30%)** - –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å–µ–∫—Ç–æ—Ä
   - –í–∫–ª–∞–¥ –≤ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å: +3.8%
   - –í–∫–ª–∞–¥ –≤ —Ä–∏—Å–∫: +4.6%
   - –°—Ç–∞—Ç—É—Å: –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –≤–µ—Å

3. **BND.US (10%)** - –û–±–ª–∏–≥–∞—Ü–∏–∏ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
   - –í–∫–ª–∞–¥ –≤ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å: +1.2%
   - –í–∫–ª–∞–¥ –≤ —Ä–∏—Å–∫: -0.5%
   - –°—Ç–∞—Ç—É—Å: –ù–µ–¥–æ–æ—Ü–µ–Ω–µ–Ω, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –¥–æ 20%

## üîÑ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–µ

### –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:
1. **–°–Ω–∏–∑–∏—Ç—å SPY.US —Å 60% –¥–æ 50%** - —Å–Ω–∏–∂–µ–Ω–∏–µ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ä–∏—Å–∫–∞
2. **–£–≤–µ–ª–∏—á–∏—Ç—å BND.US —Å 10% –¥–æ 20%** - —É–ª—É—á—à–µ–Ω–∏–µ —Ä–∏—Å–∫-–ø—Ä–æ—Ñ–∏–ª—è

### –í–∞–∂–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:
1. **–î–æ–±–∞–≤–∏—Ç—å –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –∞–∫—Ü–∏–∏ (VEA.US) 10%** - –¥–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º
2. **–†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å REIT (VNQ.US) 5%** - –¥–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ –∫–ª–∞—Å—Å–∞–º –∞–∫—Ç–∏–≤–æ–≤

### –ñ–µ–ª–∞—Ç–µ–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:
1. **–î–æ–±–∞–≤–∏—Ç—å –∑–æ–ª–æ—Ç–æ (GLD.US) 5%** - –∑–∞—â–∏—Ç–∞ –æ—Ç –∏–Ω—Ñ–ª—è—Ü–∏–∏
2. **–†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–∞–∑–≤–∏–≤–∞—é—â–∏–µ—Å—è —Ä—ã–Ω–∫–∏ (VWO.US) 5%** - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏—è

## üéØ –°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è:
1. **–¶–µ–ª–µ–≤–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ**: 50% –∞–∫—Ü–∏–∏ –°–®–ê, 20% –æ–±–ª–∏–≥–∞—Ü–∏–∏, 15% –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –∞–∫—Ü–∏–∏, 10% –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã, 5% –Ω–∞–ª–∏—á–Ω—ã–µ
2. **–ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏**: –ï–∂–µ–∫–≤–∞—Ä—Ç–∞–ª—å–Ω–æ –∏–ª–∏ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –Ω–∞ ¬±5%
3. **–ì–æ—Ä–∏–∑–æ–Ω—Ç –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**: 5-10 –ª–µ—Ç –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ü–µ–ª–µ–π

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏:
- –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–ª—é—á–µ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫
- –ö–≤–∞—Ä—Ç–∞–ª—å–Ω–∞—è —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- –ì–æ–¥–æ–≤–æ–π –ø–µ—Ä–µ—Å–º–æ—Ç—Ä —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏ —Ü–µ–ª–µ–π

## ‚ö†Ô∏è –†–∏—Å–∫-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç

### –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ä–∏—Å–∫–∏:
- **–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫**: –ü–µ—Ä–µ–≤–µ—Å –≤ –∞–∫—Ü–∏—è—Ö –°–®–ê (90% –ø–æ—Ä—Ç—Ñ–µ–ª—è)
- **–°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫**: –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –≤ –∫—Ä—É–ø–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏—è—Ö —á–µ—Ä–µ–∑ SPY –∏ QQQ
- **–ù–∏–∑–∫–∏–π —Ä–∏—Å–∫**: –•–æ—Ä–æ—à–∞—è –¥–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ —Å–µ–∫—Ç–æ—Ä–∞–º

### –ú–µ—Ä—ã –ø–æ —Å–Ω–∏–∂–µ–Ω–∏—é —Ä–∏—Å–∫–æ–≤:
1. **–ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è –¥–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏—è**: –î–æ–±–∞–≤–∏—Ç—å –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ —Ä—ã–Ω–∫–∏
2. **–ö–ª–∞—Å—Å–æ–≤–∞—è –¥–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏—è**: –í–∫–ª—é—á–∏—Ç—å REIT –∏ —Ç–æ–≤–∞—Ä—ã
3. **–í—Ä–µ–º–µ–Ω–Ω–∞—è –¥–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏—è**: –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–æ–≤

### –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏:
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è**: –ü—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ —Ü–µ–ª–µ–≤—ã—Ö –≤–µ—Å–æ–≤ –Ω–∞ ¬±5%
- **–ü–ª–∞–Ω–æ–≤–∞—è**: –ï–∂–µ–∫–≤–∞—Ä—Ç–∞–ª—å–Ω–æ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
- **–í–Ω–µ–ø–ª–∞–Ω–æ–≤–∞—è**: –ü—Ä–∏ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö —Ä—ã–Ω–æ—á–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π

## üìà –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

### –ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥:
- –£–≤–µ–ª–∏—á–∏—Ç—å –¥–æ–ª—é –æ–±–ª–∏–≥–∞—Ü–∏–π –¥–æ 30%
- –î–æ–±–∞–≤–∏—Ç—å –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ –æ–±–ª–∏–≥–∞—Ü–∏–∏ (SHY.US)
- –°–Ω–∏–∑–∏—Ç—å –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å –ø–æ—Ä—Ç—Ñ–µ–ª—è

### –ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥:
- –£–≤–µ–ª–∏—á–∏—Ç—å –¥–æ–ª—é –∞–∫—Ü–∏–π –¥–æ 80%
- –î–æ–±–∞–≤–∏—Ç—å –º–∞–ª—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ (VB.US)
- –ü–æ–≤—ã—Å–∏—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—É—é –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å

### –°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π):
- –¢–µ–∫—É—â–µ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞–º–∏
- –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö –∞–∫—Ç–∏–≤–æ–≤
- –†–µ–≥—É–ª—è—Ä–Ω–∞—è —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

### –ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:
1. **–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å**: –¶–µ–ª–µ–≤–∞—è 10-12% –≥–æ–¥–æ–≤—ã—Ö
2. **–†–∏—Å–∫**: –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å –Ω–µ –±–æ–ª–µ–µ 18%
3. **–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –®–∞—Ä–ø–∞**: –¶–µ–ª–µ–≤–æ–π >0.8
4. **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ—Å–∞–¥–∫–∞**: –ù–µ –±–æ–ª–µ–µ -15%

### –°–∏–≥–Ω–∞–ª—ã –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏:
- –°–Ω–∏–∂–µ–Ω–∏–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ –®–∞—Ä–ø–∞ –Ω–∏–∂–µ 0.6
- –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ—Å–∞–¥–∫–∏ –≤—ã—à–µ -20%
- –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –æ—Ç —Ü–µ–ª–µ–≤—ã—Ö –≤–µ—Å–æ–≤

## üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ù–∞–ª–æ–≥–æ–≤—ã–µ —Å–æ–æ–±—Ä–∞–∂–µ–Ω–∏—è:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞–ª–æ–≥–æ–≤—ã–µ –ª—å–≥–æ—Ç–Ω—ã–µ —Å—á–µ—Ç–∞ (IRA, 401k)
- –£—á–∏—Ç—ã–≤–∞—Ç—å –Ω–∞–ª–æ–≥–æ–≤—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏
- –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞–ª–æ–≥–æ–≤—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –ö–æ–º–∏—Å—Å–∏–∏ –∏ —Ä–∞—Å—Ö–æ–¥—ã:
- –ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–æ—Ä–≥–æ–≤—ã–µ –∫–æ–º–∏—Å—Å–∏–∏
- –í—ã–±–∏—Ä–∞—Ç—å ETF —Å –Ω–∏–∑–∫–∏–º–∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞–º–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤
- –ò–∑–±–µ–≥–∞—Ç—å —á–∞—Å—Ç—ã—Ö —Å–¥–µ–ª–æ–∫

### –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∞—Å–ø–µ–∫—Ç—ã:
- –ù–µ –ø–æ–¥–¥–∞–≤–∞—Ç—å—Å—è —ç–º–æ—Ü–∏—è–º –ø—Ä–∏ —Ä—ã–Ω–æ—á–Ω—ã—Ö –∫–æ–ª–µ–±–∞–Ω–∏—è—Ö
- –°–ª–µ–¥–æ–≤–∞—Ç—å –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
- –†–µ–≥—É–ª—è—Ä–Ω–æ –ø–µ—Ä–µ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Ü–µ–ª–∏ –∏ —Ç–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç—å –∫ —Ä–∏—Å–∫—É

---

**‚ö†Ô∏è –î–∏—Å–∫–ª–µ–π–º–µ—Ä**: –î–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–æ–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–µ–π. –í—Å–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –ø—Ä–∏–Ω–∏–º–∞—Ç—å—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ —Å –∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞–º–∏. –ü—Ä–æ—à–ª—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—é—Ç –±—É–¥—É—â—É—é –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å.
    """
    
    print(f"üìè –î–ª–∏–Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞: {len(long_analysis)} —Å–∏–º–≤–æ–ª–æ–≤")
    print(f"üìä –ü—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç Telegram (4000): {'–î–∞' if len(long_analysis) > 4000 else '–ù–µ—Ç'}")
    
    # Test the new method
    print("\nüîß –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –º–µ—Ç–æ–¥–∞ _send_portfolio_ai_analysis_with_keyboard...")
    
    # Create a mock update object for testing
    class MockUpdate:
        def __init__(self):
            self.effective_chat = MockChat()
    
    class MockChat:
        def __init__(self):
            self.id = 12345
    
    class MockContext:
        def __init__(self):
            self.bot = MockBot()
    
    class MockBot:
        async def send_message(self, chat_id, text, parse_mode=None, reply_markup=None):
            print(f"üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:")
            print(f"   –î–ª–∏–Ω–∞: {len(text)} —Å–∏–º–≤–æ–ª–æ–≤")
            print(f"   Parse mode: {parse_mode}")
            print(f"   Reply markup: {'–ï—Å—Ç—å' if reply_markup else '–ù–µ—Ç'}")
            if len(text) > 100:
                print(f"   –ù–∞—á–∞–ª–æ: {text[:100]}...")
            else:
                print(f"   –°–æ–¥–µ—Ä–∂–∏–º–æ–µ: {text}")
            print()
    
    mock_update = MockUpdate()
    mock_context = MockContext()
    
    try:
        # Test the new method
        await bot._send_portfolio_ai_analysis_with_keyboard(
            mock_update, 
            mock_context, 
            long_analysis, 
            parse_mode='Markdown'
        )
        print("‚úÖ –¢–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!")
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –≤ —Ç–µ—Å—Ç–µ: {e}")
        import traceback
        traceback.print_exc()
    
    print("\n" + "=" * 60)
    print("üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:")
    print("‚úÖ –ù–æ–≤—ã–π –º–µ—Ç–æ–¥ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–ª–∏–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è")
    print("‚úÖ –°–æ–æ–±—â–µ–Ω–∏—è —Ä–∞–∑–±–∏–≤–∞—é—Ç—Å—è –Ω–∞ —á–∞—Å—Ç–∏ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞")
    print("‚úÖ –ü–µ—Ä–≤–∞—è —á–∞—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π")
    print("‚úÖ –û—Å—Ç–∞–ª—å–Ω—ã–µ —á–∞—Å—Ç–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –±–µ–∑ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã")
    print("‚úÖ –î–æ–±–∞–≤–ª—è—é—Ç—Å—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —á–∞—Å—Ç–µ–π –¥–ª—è –º–Ω–æ–≥–æ—á–∞—Å—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π")

if __name__ == "__main__":
    asyncio.run(test_portfolio_ai_truncation_fix())
