# Long Message Handling Fix Report

**Date:** September 7, 2025  
**Issue:** Message is too long error in AI data analysis  
**Status:** ‚úÖ Fixed

## –ü—Ä–æ–±–ª–µ–º–∞

**–û—à–∏–±–∫–∞:** `Message is too long` –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ AI –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö  
**–ü—Ä–∏—á–∏–Ω–∞:** Gemini API –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª –æ—Ç–≤–µ—Ç—ã –¥–ª–∏–Ω–Ω–µ–µ 4096 —Å–∏–º–≤–æ–ª–æ–≤ (–ª–∏–º–∏—Ç Telegram)

## –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã

### üîç **–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**

**–ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö:**
1. **–§—É–Ω–∫—Ü–∏—è `_send_callback_message`** –Ω–µ –æ–±—Ä–µ–∑–∞–ª–∞ –¥–ª–∏–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
2. **Gemini —Å–µ—Ä–≤–∏—Å** –º–æ–≥ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç—ã –¥–ª–∏–Ω–Ω–µ–µ –ª–∏–º–∏—Ç–∞ Telegram
3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª–∏–Ω—ã** –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Å–æ–æ–±—â–µ–Ω–∏–π

**–û—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö:**
```
2025-09-07 12:52:24,097 - ERROR - Error sending callback message: Message is too long
2025-09-07 12:52:24,097 - ERROR - Cannot send message: update.message is None
```

## –†–µ—à–µ–Ω–∏–µ

### ‚úÖ **1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `_send_callback_message`**

**–§–∞–π–ª:** `bot.py` (—Å—Ç—Ä–æ–∫–∏ 3272-3316)

**–î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–µ–∑–∫–∞ –¥–ª–∏–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:**
```python
async def _send_callback_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE, text: str, parse_mode: str = None):
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ callback query - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ None –∏ –¥–ª–∏–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    try:
        # –û–±—Ä–µ–∑–∞–µ–º —Ç–µ–∫—Å—Ç –¥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω—ã Telegram (4096 —Å–∏–º–≤–æ–ª–æ–≤)
        max_length = 4096
        if len(text) > max_length:
            text = text[:max_length-50] + "\n\n... (—Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–µ–∑–∞–Ω–æ –∏–∑-–∑–∞ –¥–ª–∏–Ω—ã)"
            self.logger.warning(f"Message truncated from {len(text)+50} to {len(text)} characters")
        
        # ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
```

### ‚úÖ **2. –£–ª—É—á—à–µ–Ω Gemini —Å–µ—Ä–≤–∏—Å**

**–§–∞–π–ª:** `services/gemini_service.py` (—Å—Ç—Ä–æ–∫–∏ 309-314, 370-383)

**–£–≤–µ–ª–∏—á–µ–Ω –ª–∏–º–∏—Ç —Ç–æ–∫–µ–Ω–æ–≤ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–µ–∑–∫–∞:**
```python
"generationConfig": {
    "temperature": 0.7,
    "topK": 40,
    "topP": 0.95,
    "maxOutputTokens": 3000,  # –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
}

# –û–±—Ä–µ–∑–∞–µ–º –∞–Ω–∞–ª–∏–∑ –µ—Å–ª–∏ –æ–Ω —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π –¥–ª—è Telegram
analysis_text = full_analysis_text.strip()
max_length = 4000  # –û—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–ø–∞—Å –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

if len(analysis_text) > max_length:
    analysis_text = analysis_text[:max_length-50] + "\n\n... (–∞–Ω–∞–ª–∏–∑ –æ–±—Ä–µ–∑–∞–Ω –∏–∑-–∑–∞ –¥–ª–∏–Ω—ã)"
    logger.warning(f"Analysis truncated from {len(full_analysis_text)} to {len(analysis_text)} characters")
```

### ‚úÖ **3. –°–æ–∑–¥–∞–Ω –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ç–µ—Å—Ç**

**–§–∞–π–ª:** `tests/test_long_message_handling.py`

**–ü—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –û–±—Ä–µ–∑–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π –≤ `_send_callback_message`
- –û–±—Ä–µ–∑–∫—É –∞–Ω–∞–ª–∏–∑–∞ –≤ Gemini —Å–µ—Ä–≤–∏—Å–µ
- –û–±—Ä–∞–±–æ—Ç–∫—É —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –¥–ª–∏–Ω —Å–æ–æ–±—â–µ–Ω–∏–π
- –û–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–ª–∏–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### ‚úÖ **–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```
‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: Message is too long
‚ùå Cannot send message: update.message is None
```

### ‚úÖ **–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```
‚úÖ –°–æ–æ–±—â–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–µ–∑–∞—é—Ç—Å—è –¥–æ 4096 —Å–∏–º–≤–æ–ª–æ–≤
‚úÖ –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–±—Ä–µ–∑–∫–∏ "... (—Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–µ–∑–∞–Ω–æ –∏–∑-–∑–∞ –¥–ª–∏–Ω—ã)"
‚úÖ –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –æ–±—Ä–µ–∑–∫–µ
‚úÖ AI –∞–Ω–∞–ª–∏–∑ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
```

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### **–õ–∏–º–∏—Ç—ã Telegram:**
- **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:** 4096 —Å–∏–º–≤–æ–ª–æ–≤
- **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –ø–æ–¥–ø–∏—Å–∏ –∫ —Ñ–æ—Ç–æ:** 1024 —Å–∏–º–≤–æ–ª–∞
- **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ callback_data:** 64 –±–∞–π—Ç–∞

### **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏:**
1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π** - –æ–±—Ä–µ–∑–∫–∞ –¥–æ 4096 —Å–∏–º–≤–æ–ª–æ–≤
2. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–µ–∑–∫–∏** - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤ –ª–æ–≥–∞—Ö
3. **–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–±—Ä–µ–∑–∫–∏** - "... (—Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–µ–∑–∞–Ω–æ –∏–∑-–∑–∞ –¥–ª–∏–Ω—ã)"
4. **Fallback –æ–±—Ä–∞–±–æ—Ç–∫–∞** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### **–£–ª—É—á—à–µ–Ω–∏—è Gemini API:**
- **–£–≤–µ–ª–∏—á–µ–Ω maxOutputTokens** —Å 2048 –¥–æ 3000
- **–î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–µ–∑–∫–∞ –æ—Ç–≤–µ—Ç–∞** –¥–æ 4000 —Å–∏–º–≤–æ–ª–æ–≤
- **–°–æ—Ö—Ä–∞–Ω–µ–Ω –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑** –≤ –ø–æ–ª–µ `full_analysis`

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç `test_long_message_handling.py` —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π:**

1. ‚úÖ **test_send_callback_message_truncation** - –û–±—Ä–µ–∑–∫–∞ –≤ callback —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
2. ‚úÖ **test_gemini_analysis_truncation** - –û–±—Ä–µ–∑–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ Gemini
3. ‚úÖ **test_message_length_limits** - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –¥–ª–∏–Ω
4. ‚úÖ **test_error_handling_with_long_messages** - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
5. ‚úÖ **test_send_message_safe_long_message** - –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ _send_message_safe

**–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:** –í—Å–µ 5 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ ‚úÖ

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### **–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–ø–æ–ª–Ω—è–µ—Ç AI –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö
2. Gemini API –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
3. –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–ª–∏–Ω—É –æ—Ç–≤–µ—Ç–∞
4. –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –¥–ª–∏–Ω–Ω–µ–µ 4096 —Å–∏–º–≤–æ–ª–æ–≤ - –æ–±—Ä–µ–∑–∞–µ—Ç—Å—è
5. –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–±—Ä–µ–∑–∫–∏
6. –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
7. –í –ª–æ–≥–∞—Ö –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ–± –æ–±—Ä–µ–∑–∫–µ

### **–ü—Ä–∏–º–µ—Ä –æ–±—Ä–µ–∑–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:**
```
[–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∞–∫—Ç–∏–≤–æ–≤...]

... (—Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–µ–∑–∞–Ω–æ –∏–∑-–∑–∞ –¥–ª–∏–Ω—ã)
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü—Ä–æ–±–ª–µ–º–∞ —Å –¥–ª–∏–Ω–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω–∞:

- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–µ–∑–∫–∞** —Å–æ–æ–±—â–µ–Ω–∏–π –¥–æ –ª–∏–º–∏—Ç–∞ Telegram
- ‚úÖ **–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –æ–±—Ä–µ–∑–∫–∏** –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –æ–±—Ä–µ–∑–∫–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- ‚úÖ **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞** –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
- ‚úÖ **–ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ

–¢–µ–ø–µ—Ä—å AI –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –¥–ª–∏–Ω—ã –æ—Ç–≤–µ—Ç–∞ Gemini API.
