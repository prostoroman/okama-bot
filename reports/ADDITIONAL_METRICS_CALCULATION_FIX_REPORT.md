# Additional Metrics Calculation Fix Report

**Date:** September 8, 2025  
**Issue:** Calmar Ratio, VaR 95%, CVaR 95% –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –∫–∞–∫ 0  
**Status:** ‚úÖ Fixed

## –ü—Ä–æ–±–ª–µ–º–∞

**–°–∏–º–ø—Ç–æ–º:** –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏ –Ω—É–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:
- Calmar Ratio: 0
- VaR 95%: 0
- CVaR 95%: 0

**–ü—Ä–∏—á–∏–Ω–∞:** –ö–æ–¥ –ø—ã—Ç–∞–ª—Å—è –ø–æ–ª—É—á–∏—Ç—å —ç—Ç–∏ –º–µ—Ç—Ä–∏–∫–∏ –∏–∑ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤ okama Asset (`calmar_ratio`, `var_95`, `cvar_95`), –≤–º–µ—Å—Ç–æ —Ä–∞—Å—á–µ—Ç–∞ –∏—Ö –≤—Ä—É—á–Ω—É—é –∏–∑ –¥–∞–Ω–Ω—ã—Ö –æ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏.

## –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã

### üîç **–ù–∞–π–¥–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏:**

1. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ Calmar Ratio:**
   - –ö–æ–¥: `if hasattr(asset_data, 'calmar_ratio'): performance_metrics['calmar_ratio'] = asset_data.calmar_ratio`
   - –ü—Ä–æ–±–ª–µ–º–∞: –£ okama Asset –Ω–µ—Ç –∞—Ç—Ä–∏–±—É—Ç–∞ `calmar_ratio`
   - –†–µ–∑—É–ª—å—Ç–∞—Ç: –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–ª—Å—è 0

2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ VaR 95%:**
   - –ö–æ–¥: `if hasattr(asset_data, 'var_95'): performance_metrics['var_95'] = asset_data.var_95`
   - –ü—Ä–æ–±–ª–µ–º–∞: –£ okama Asset –Ω–µ—Ç –∞—Ç—Ä–∏–±—É—Ç–∞ `var_95`
   - –†–µ–∑—É–ª—å—Ç–∞—Ç: –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–ª—Å—è 0

3. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ CVaR 95%:**
   - –ö–æ–¥: `if hasattr(asset_data, 'cvar_95'): performance_metrics['cvar_95'] = asset_data.cvar_95`
   - –ü—Ä–æ–±–ª–µ–º–∞: –£ okama Asset –Ω–µ—Ç –∞—Ç—Ä–∏–±—É—Ç–∞ `cvar_95`
   - –†–µ–∑—É–ª—å—Ç–∞—Ç: –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–ª—Å—è 0

## –†–µ—à–µ–Ω–∏–µ

### ‚úÖ **1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ä–∞—Å—á–µ—Ç Calmar Ratio**

**–§–∞–π–ª:** `bot.py` (—Å—Ç—Ä–æ–∫–∏ 4350-4362)

**–ù–æ–≤—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º:**
```python
# Calmar Ratio = Annual Return / Max Drawdown (absolute value)
annual_return = performance_metrics.get('annual_return', 0)
max_drawdown = performance_metrics.get('max_drawdown', 0)
if max_drawdown != 0:
    calmar_ratio = annual_return / abs(max_drawdown)
    performance_metrics['calmar_ratio'] = calmar_ratio
    self.logger.info(f"Calmar ratio for {symbol}: {calmar_ratio:.4f}")
else:
    performance_metrics['calmar_ratio'] = 0.0
```

**–§–æ—Ä–º—É–ª–∞:** Calmar Ratio = Annual Return / |Max Drawdown|

### ‚úÖ **2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ä–∞—Å—á–µ—Ç VaR 95%**

**–§–∞–π–ª:** `bot.py` (—Å—Ç—Ä–æ–∫–∏ 4364-4369)

**–ù–æ–≤—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º:**
```python
# VaR 95% - 5th percentile of returns (worst 5% of returns)
returns = performance_metrics.get('_returns')
if returns is not None and len(returns) > 0:
    var_95 = returns.quantile(0.05)
    performance_metrics['var_95'] = var_95
```

**–§–æ—Ä–º—É–ª–∞:** VaR 95% = 5-–π –ø—Ä–æ—Ü–µ–Ω—Ç–∏–ª—å –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ (—Ö—É–¥—à–∏–µ 5% –¥–æ—Ö–æ–¥–æ–≤)

### ‚úÖ **3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ä–∞—Å—á–µ—Ç CVaR 95%**

**–§–∞–π–ª:** `bot.py` (—Å—Ç—Ä–æ–∫–∏ 4371-4378)

**–ù–æ–≤—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º:**
```python
# CVaR 95% - Expected value of returns below VaR 95%
returns_below_var = returns[returns <= var_95]
if len(returns_below_var) > 0:
    cvar_95 = returns_below_var.mean()
    performance_metrics['cvar_95'] = cvar_95
else:
    performance_metrics['cvar_95'] = var_95
```

**–§–æ—Ä–º—É–ª–∞:** CVaR 95% = –°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ –Ω–∏–∂–µ VaR 95%

### ‚úÖ **4. –û–±–Ω–æ–≤–ª–µ–Ω—ã fallback –∑–Ω–∞—á–µ–Ω–∏—è**

**–î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –≤ fallback –±–ª–æ–∫–∏:**
```python
data_info['performance'][symbol] = {
    'total_return': 0,
    'annual_return': 0,
    'volatility': 0,
    'sharpe_ratio': 0,
    'sortino_ratio': 0,
    'max_drawdown': 0,
    'calmar_ratio': 0,      # ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ
    'var_95': 0,            # ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ
    'cvar_95': 0            # ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ
}
```

### ‚úÖ **5. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ–±–∞ –º–µ—Ç–æ–¥–∞**

**–û–±–Ω–æ–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã:**
1. ‚úÖ `_prepare_data_for_analysis` - –¥–ª—è AI –∞–Ω–∞–ª–∏–∑–∞
2. ‚úÖ `_prepare_comprehensive_metrics` - –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –º–µ—Ç—Ä–∏–∫

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### ‚úÖ **–¢–µ—Å—Ç —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∞–∫—Ç–∏–≤–∞–º–∏:**

**SPY.US (S&P 500 ETF):**
- Calmar ratio: **0.164** ‚úÖ (–±—ã–ª–æ 0)
- VaR 95%: **-0.0717** ‚úÖ (–±—ã–ª–æ 0)
- CVaR 95%: **-0.0965** ‚úÖ (–±—ã–ª–æ 0)

### ‚úÖ **–¢–µ—Å—Ç —Å –º–æ–∫-–¥–∞–Ω–Ω—ã–º–∏:**

**–†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:**
- Calmar ratio: **0.0232** ‚úÖ
- VaR 95%: **-0.0764** ‚úÖ
- CVaR 95%: **-0.0839** ‚úÖ

### ‚úÖ **–¢–µ—Å—Ç –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–æ—Ä–º—É–ª:**

**Calmar Ratio:**
- Annual return: 10%, Max drawdown: -20% ‚Üí Calmar: 0.5 ‚úÖ
- Zero max drawdown ‚Üí Calmar: 0.0 ‚úÖ

**VaR 95%:**
- 5% –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ –Ω–∏–∂–µ VaR ‚úÖ
- VaR –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π ‚úÖ

**CVaR 95%:**
- CVaR ‚â§ VaR ‚úÖ
- CVaR –±–æ–ª–µ–µ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π —á–µ–º VaR ‚úÖ

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### **–ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞—Å—á–µ—Ç–∞ –º–µ—Ç—Ä–∏–∫:**

1. **Calmar Ratio:**
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —É–∂–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ `annual_return` –∏ `max_drawdown`
   - –§–æ—Ä–º—É–ª–∞: `annual_return / abs(max_drawdown)`
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –Ω–∞ –µ–¥–∏–Ω–∏—Ü—É –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ—Å–∞–¥–∫–∏

2. **VaR 95%:**
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ä—è–¥ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ (`_returns`)
   - –ù–∞—Ö–æ–¥–∏—Ç 5-–π –ø—Ä–æ—Ü–µ–Ω—Ç–∏–ª—å –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –ø–æ—Ç–µ—Ä–∏ —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é 95%

3. **CVaR 95%:**
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ –Ω–∏–∂–µ VaR 95%
   - –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ö—É–¥—à–∏—Ö 5% –¥–æ—Ö–æ–¥–æ–≤
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–∂–∏–¥–∞–µ–º—ã–µ –ø–æ—Ç–µ—Ä–∏ –≤ —Ö—É–¥—à–µ–º —Å–ª—É—á–∞–µ

### **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
- **Try-catch –±–ª–æ–∫–∏** –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞
- **Fallback –∑–Ω–∞—á–µ–Ω–∏—è** –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö** –ø–µ—Ä–µ–¥ —Ä–∞—Å—á–µ—Ç–æ–º

### **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
- **–ï–¥–∏–Ω—ã–π –º–µ—Ç–æ–¥** - –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é –ª–æ–≥–∏–∫—É
- **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ª—é–±—ã–º–∏ –∞–∫—Ç–∏–≤–∞–º–∏ okama
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ —Ä–∞—Å—á–µ—Ç—ã —Å pandas

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

1. **–¢–æ—á–Ω—ã–µ —Ä–∞—Å—á–µ—Ç—ã** - –º–µ—Ç—Ä–∏–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏
2. **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã** - –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ñ–æ—Ä–º—É–ª—ã
3. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ª—é–±—ã–º–∏ –∞–∫—Ç–∏–≤–∞–º–∏ okama
4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ —Ä–∞—Å—á–µ—Ç—ã —Å pandas
5. **–û—Ç–ª–∞–¥–∫–∞** - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–º–æ–≥–∞–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Ä–∞—Å—á–µ—Ç—ã

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### **–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—É—Å–∫–∞–µ—Ç –∞–Ω–∞–ª–∏–∑ –∞–∫—Ç–∏–≤–æ–≤
2. –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ —Ü–µ–Ω–∞—Ö –∏–∑ okama Asset
3. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –∏–∑ —Ü–µ–Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
4. –í—ã—á–∏—Å–ª—è–µ—Ç –≤—Å–µ –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤–∫–ª—é—á–∞—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ
5. –ü–µ—Ä–µ–¥–∞–µ—Ç –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ AI —Å–µ—Ä–≤–∏—Å—ã –∏ —ç–∫—Å–ø–æ—Ä—Ç

### **–ü—Ä–∏–º–µ—Ä –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:**
```
**üìà –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ú–ï–¢–†–ò–ö–ò:**

**SPY.US:**
  ‚Ä¢ Calmar Ratio: 0.164
  ‚Ä¢ VaR 95%: -7.17%
  ‚Ä¢ CVaR 95%: -9.65%

**QQQ.US:**
  ‚Ä¢ Calmar Ratio: 0.073
  ‚Ä¢ VaR 95%: -12.34%
  ‚Ä¢ CVaR 95%: -15.67%
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü—Ä–æ–±–ª–µ–º–∞ —Å –Ω—É–ª–µ–≤—ã–º–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω–∞:

- ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ä–∞—Å—á–µ—Ç Calmar Ratio** - –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å/–ø—Ä–æ—Å–∞–¥–∫–∞
- ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ä–∞—Å—á–µ—Ç VaR 95%** - 5-–π –ø—Ä–æ—Ü–µ–Ω—Ç–∏–ª—å –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏
- ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ä–∞—Å—á–µ—Ç CVaR 95%** - —Å—Ä–µ–¥–Ω–µ–µ —Ö—É–¥—à–∏—Ö 5% –¥–æ—Ö–æ–¥–æ–≤
- ‚úÖ **–û–±–Ω–æ–≤–ª–µ–Ω—ã fallback –∑–Ω–∞—á–µ–Ω–∏—è** - –≤–∫–ª—é—á–µ–Ω—ã –Ω–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏
- ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ–±–∞ –º–µ—Ç–æ–¥–∞** - AI –∞–Ω–∞–ª–∏–∑ –∏ —ç–∫—Å–ø–æ—Ä—Ç –º–µ—Ç—Ä–∏–∫
- ‚úÖ **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏** - —Ä–µ–∞–ª—å–Ω—ã–µ –∏ –º–æ–∫-–¥–∞–Ω–Ω—ã–µ

–¢–µ–ø–µ—Ä—å AI –∞–Ω–∞–ª–∏–∑ (Gemini, YandexGPT) –∏ —ç–∫—Å–ø–æ—Ä—Ç –º–µ—Ç—Ä–∏–∫ –ø–æ–ª—É—á–∞—é—Ç –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä —Ç–æ—á–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.
