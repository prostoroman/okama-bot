# Markdown Parsing Fix Report

## –ó–∞–¥–∞—á–∞

**–î–∞—Ç–∞:** 2025-01-27  
**–ó–∞–¥–∞—á–∞:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ Markdown –≤ –∫–æ–º–∞–Ω–¥–µ `/list` –¥–ª—è –∫–∏—Ç–∞–π—Å–∫–∏—Ö –±–∏—Ä–∂  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ

## –ü—Ä–æ–±–ª–µ–º–∞

**–û—à–∏–±–∫–∏:**
```
‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è 'SSE': Can't parse entities: can't find end of the entity starting at byte offset 109
‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è 'SZSE': Can't parse entities: can't find end of the entity starting at byte offset 110
```

**–ü—Ä–∏—á–∏–Ω–∞:**
- –í –Ω–∞–∑–≤–∞–Ω–∏—è—Ö –∫–æ–º–ø–∞–Ω–∏–π –µ—Å—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã Markdown (—Å–∫–æ–±–∫–∏, –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è, –∑–≤–µ–∑–¥–æ—á–∫–∏ –∏ –¥—Ä.)
- –≠—Ç–∏ —Å–∏–º–≤–æ–ª—ã –Ω–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã –∏ –≤—ã–∑—ã–≤–∞—é—Ç –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤ Telegram
- –û—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–æ–±–ª–µ–º–∞—Ç–∏—á–Ω—ã —Å–∫–æ–±–∫–∏ `()` –≤ –Ω–∞–∑–≤–∞–Ω–∏—è—Ö –∫–∏—Ç–∞–π—Å–∫–∏—Ö –∫–æ–º–ø–∞–Ω–∏–π

**–ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π:**
- `Ping An Bank Co Ltd (Âπ≥ÂÆâÈì∂Ë°åËÇ°‰ªΩÊúâÈôêÂÖ¨Âè∏)`
- `China Vanke Co Ltd (‰∏≠ÂõΩ‰∏áÁßëËÇ°‰ªΩÊúâÈôêÂÖ¨Âè∏)`
- `Shanghai Pudong Development Bank Co Ltd (‰∏äÊµ∑Êµ¶‰∏úÂèëÂ±ïÈì∂Ë°åËÇ°‰ªΩÊúâÈôêÂÖ¨Âè∏)`

## –†–µ—à–µ–Ω–∏–µ

### ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è Markdown —Å–∏–º–≤–æ–ª–æ–≤:**

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**

1. **–°–æ–∑–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `_escape_markdown`:**
```python
def _escape_markdown(self, text: str) -> str:
    """Escape special Markdown characters"""
    if not text:
        return text
    
    # Escape special Markdown characters
    escape_chars = ['_', '*', '[', ']', '(', ')', '~', '`', '>', '#', '+', '-', '=', '|', '{', '}', '.', '!']
    for char in escape_chars:
        text = text.replace(char, f'\\{char}')
    return text
```

2. **–ü—Ä–∏–º–µ–Ω–µ–Ω–æ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫ –∫–∏—Ç–∞–π—Å–∫–∏–º –±–∏—Ä–∂–∞–º:**
```python
# Before
table_data.append([f"`{symbol}`", name])

# After
escaped_name = self._escape_markdown(name)
table_data.append([f"`{symbol}`", escaped_name])
```

3. **–ü—Ä–∏–º–µ–Ω–µ–Ω–æ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫ –æ–±—ã—á–Ω—ã–º –±–∏—Ä–∂–∞–º:**
```python
# Before
table_data.append([f"`{symbol}`", name])

# After
escaped_name = self._escape_markdown(name)
table_data.append([f"`{symbol}`", escaped_name])
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞:**
- –£—Å—Ç—Ä–∞–Ω–µ–Ω—ã –æ—à–∏–±–∫–∏ "Can't parse entities" –¥–ª—è SSE –∏ SZSE
- –í—Å–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã Markdown —Ç–µ–ø–µ—Ä—å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã
- –¢–∞–±–ª–∏—Ü—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ Telegram

### ‚úÖ **–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

**–î–æ (–ø—Ä–æ–±–ª–µ–º–∞—Ç–∏—á–Ω–æ):**
```
| `000001.SZ` | Ping An Bank Co Ltd (Âπ≥ÂÆâÈì∂Ë°åËÇ°‰ªΩÊúâÈôêÂÖ¨Âè∏) |
```

**–ü–æ—Å–ª–µ (–±–µ–∑–æ–ø–∞—Å–Ω–æ):**
```
| `000001.SZ` | Ping An Bank Co Ltd \(Âπ≥ÂÆâÈì∂Ë°åËÇ°‰ªΩÊúâÈôêÂÖ¨Âè∏\) |
```

### ‚úÖ **–≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã:**
- `(` ‚Üí `\(`
- `)` ‚Üí `\)`
- `_` ‚Üí `\_`
- `*` ‚Üí `\*`
- `[` ‚Üí `\[`
- `]` ‚Üí `\]`
- `~` ‚Üí `\~`
- `` ` `` ‚Üí `` \` ``
- `>` ‚Üí `\>`
- `#` ‚Üí `\#`
- `+` ‚Üí `\+`
- `-` ‚Üí `\-`
- `=` ‚Üí `\=`
- `|` ‚Üí `\|`
- `{` ‚Üí `\{`
- `}` ‚Üí `\}`
- `.` ‚Üí `\.`
- `!` ‚Üí `\!`

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### ‚úÖ **–°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç:**
- `scripts/test_markdown_escaping.py` - –ø–æ–ª–Ω—ã–π —Ç–µ—Å—Ç —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

### ‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
- ‚úÖ –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã: –ü—Ä–∞–≤–∏–ª—å–Ω–æ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã
- ‚úÖ –ö–∏—Ç–∞–π—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã: –ù–µ –º–µ—à–∞—é—Ç –ø–∞—Ä—Å–∏–Ω–≥—É Markdown
- ‚úÖ –¢–∞–±–ª–∏—Ü—ã: –ë–µ–∑–æ–ø–∞—Å–Ω—ã –¥–ª—è Telegram Markdown –ø–∞—Ä—Å–∏–Ω–≥–∞
- ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ

### ‚úÖ **–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å–ª—É—á–∞–∏:**
- –°–∫–æ–±–∫–∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏—è—Ö: `Company Name (with parentheses)`
- –ü–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è: `Company_Name_with_underscores`
- –ó–≤–µ–∑–¥–æ—á–∫–∏: `Company*Name*with*asterisks`
- –ö–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —Å–∫–æ–±–∫–∏: `Company[Name]with[brackets]`
- –ò –¥—Ä—É–≥–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### **–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- `bot.py` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `_escape_markdown` –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫ —Ç–∞–±–ª–∏—Ü–∞–º
- `scripts/test_markdown_escaping.py` - —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç

### **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:**
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ TABULATE —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ
- ‚úÖ `parse_mode='Markdown'` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ö–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ Excel —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ –ø—Ä–µ–∂–¥–µ

### **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- –§—É–Ω–∫—Ü–∏—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –±—ã—Å—Ç—Ä–æ
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫ —Ç–µ–∫—Å—Ç—É —Ç–∞–±–ª–∏—Ü

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–í—Å–µ –ø—Ä–æ–±–ª–µ–º—ã —Ä–µ—à–µ–Ω—ã:**
- ‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω—ã –æ—à–∏–±–∫–∏ "Can't parse entities"
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ Markdown
- ‚úÖ –¢–∞–±–ª–∏—Ü—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ Telegram
- ‚úÖ –ü—Ä–æ–≤–µ–¥–µ–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ç–µ–ø–µ—Ä—å –ø–æ–ª—É—á–∞—é—Ç:**
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã –±–µ–∑ –æ—à–∏–±–æ–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏–π –∫–æ–º–ø–∞–Ω–∏–π
- –°—Ç–∞–±–∏–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É –∫–æ–º–∞–Ω–¥—ã `/list` –¥–ª—è –≤—Å–µ—Ö –±–∏—Ä–∂
- –ö—Ä–∞—Å–∏–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã —Å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏

**–ö–æ–º–º–∏—Ç:** –ì–æ—Ç–æ–≤ –∫ –∫–æ–º–º–∏—Ç—É - –≤—Å–µ –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã! üéâ
