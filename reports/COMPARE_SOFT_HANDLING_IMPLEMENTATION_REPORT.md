# –û—Ç—á–µ—Ç –æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –º—è–≥–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥—ã /compare

## üéØ –¶–µ–ª—å

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º—è–≥–∫—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª—è –∫–æ–º–∞–Ω–¥—ã `/compare` –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ 1 —Å–∏–º–≤–æ–ª –≤–º–µ—Å—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ. –í–º–µ—Å—Ç–æ –æ—à–∏–±–∫–∏ "‚ùå –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è" –≤—ã–≤–æ–¥–∏—Ç—å –∑–∞–ø—Ä–æ—Å "–í—ã —É–∫–∞–∑–∞–ª–∏ —Ç–æ–ª—å–∫–æ 1 —Å–∏–º–≤–æ–ª, –∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –Ω—É–∂–Ω–æ 2 –∏ –±–æ–ª—å—à–µ, –Ω–∞–ø–∏—à–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–∏–º–≤–æ–ª –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è, –Ω–∞–ø—Ä–∏–º–µ—Ä `—Å–ª—É—á–∞–π–Ω—ã–π —Å–∏–º–≤–æ–ª`".

## üîß –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–§–∞–π–ª:** `services/context_store.py`

–î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –ø–æ–ª—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
- `compare_first_symbol`: –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–µ—Ä–≤–æ–≥–æ –≤–≤–µ–¥–µ–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
- `waiting_for_compare`: —Ñ–ª–∞–≥ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è

```python
# Compare command context
"compare_first_symbol": None,
"waiting_for_compare": False,
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã /compare

**–§–∞–π–ª:** `bot.py` - —Ñ—É–Ω–∫—Ü–∏—è `compare_command`

#### –°–±—Ä–æ—Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –ø—É—Å—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ
```python
# Clear any existing compare context when starting fresh
self._update_user_context(user_id, compare_first_symbol=None, waiting_for_compare=False)
```

#### –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
```python
# Check if we have a stored first symbol and only 1 symbol in current input
user_context = self._get_user_context(user_id)
stored_first_symbol = user_context.get('compare_first_symbol')

if len(symbols) == 1 and stored_first_symbol is not None:
    # Combine stored symbol with current input
    symbols = [stored_first_symbol] + symbols
    # Clear the stored symbol
    self._update_user_context(user_id, compare_first_symbol=None)
    self.logger.info(f"Combined with stored symbol: {symbols}")
```

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –≤–≤–æ–¥–∞

**–§–∞–π–ª:** `bot.py` - —Ñ—É–Ω–∫—Ü–∏—è `_handle_compare_input`

#### –õ–æ–≥–∏–∫–∞ –º—è–≥–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
```python
# Check if we have a stored first symbol from previous input
stored_first_symbol = user_context.get('compare_first_symbol')

if len(symbols) == 1:
    if stored_first_symbol is None:
        # First symbol - store it and ask for more
        self._update_user_context(user_id, compare_first_symbol=symbols[0])
        await self._send_message_safe(update, f"–í—ã —É–∫–∞–∑–∞–ª–∏ —Ç–æ–ª—å–∫–æ 1 —Å–∏–º–≤–æ–ª, –∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –Ω—É–∂–Ω–æ 2 –∏ –±–æ–ª—å—à–µ, –Ω–∞–ø–∏—à–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–∏–º–≤–æ–ª –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è, –Ω–∞–ø—Ä–∏–º–µ—Ä `—Å–ª—É—á–∞–π–Ω—ã–π —Å–∏–º–≤–æ–ª`")
        return
    else:
        # We have a stored symbol, combine with new input
        combined_symbols = [stored_first_symbol] + symbols
        # Clear the stored symbol
        self._update_user_context(user_id, compare_first_symbol=None)
        
        # Process the comparison with combined symbols
        context.args = combined_symbols
        context.specified_currency = specified_currency
        context.specified_period = specified_period
        
        await self.compare_command(update, context)
        return
```

## üìã –°—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü–µ—Ä–≤—ã–π –≤–≤–æ–¥ –æ–¥–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç `/compare`
2. –ë–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø—Ä–∞–≤–∫—É –∏ –∂–¥–µ—Ç –≤–≤–æ–¥
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç `AAPL.US`
4. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–æ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–∏–º–≤–æ–ª –∏ –ø—Ä–æ—Å–∏—Ç –≤–≤–µ—Å—Ç–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–∏–º–≤–æ–ª

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –í—Ç–æ—Ä–æ–π –≤–≤–æ–¥ –æ–¥–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
1. –ü–æ—Å–ª–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç `MSFT.US`
2. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–æ—Ç –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç —Å–∏–º–≤–æ–ª—ã (`AAPL.US MSFT.US`) –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –í–≤–æ–¥ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç `/compare`
2. –ë–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø—Ä–∞–≤–∫—É –∏ –∂–¥–µ—Ç –≤–≤–æ–¥
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç `AAPL.US MSFT.US GOOGL.US`
4. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–æ—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–∏–º–≤–æ–ª–æ–≤

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –°–±—Ä–æ—Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç `/compare` (–ø—É—Å—Ç–∞—è –∫–æ–º–∞–Ω–¥–∞)
2. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–æ—Ç —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø—Ä–∞–≤–∫—É

### –°—Ü–µ–Ω–∞—Ä–∏–π 5: –ü—É—Å—Ç–æ–π –≤–≤–æ–¥
1. –ü–æ—Å–ª–µ –≤–≤–æ–¥–∞ –æ–¥–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
2. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–æ—Ç —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ç–µ—Å—Ç `tests/test_compare_soft_handling.py` –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:

1. ‚úÖ –°–±—Ä–æ—Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –ø—É—Å—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ `/compare`
2. ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–≤–æ–≥–æ –≤–≤–æ–¥–∞ –æ–¥–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
3. ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ç–æ—Ä–æ–≥–æ –≤–≤–æ–¥–∞ –æ–¥–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞ (–æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ)
4. ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
5. ‚úÖ –û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –ø—É—Å—Ç–æ–º –≤–≤–æ–¥–µ
6. ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã `/compare` —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º —Å–∏–º–≤–æ–ª–æ–º

**–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:** 6/6 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ

## üîÑ –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

```mermaid
graph TD
    A[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç /compare] --> B{–ï—Å—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç—ã?}
    B -->|–ù–µ—Ç| C[–°–±—Ä–æ—Å–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç<br/>–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É]
    B -->|–î–∞| D[–ü–∞—Ä—Å–∏–Ω–≥ —Å–∏–º–≤–æ–ª–æ–≤]
    
    D --> E{–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–º–≤–æ–ª–æ–≤?}
    E -->|0| F[–û—à–∏–±–∫–∞: –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞]
    E -->|1| G{–ï—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª?}
    E -->|2+| H[–û—á–∏—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç<br/>–í—ã–ø–æ–ª–Ω–∏—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ]
    
    G -->|–ù–µ—Ç| I[–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–∏–º–≤–æ–ª<br/>–ó–∞–ø—Ä–æ—Å–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π]
    G -->|–î–∞| J[–û–±—ä–µ–¥–∏–Ω–∏—Ç—å —Å–∏–º–≤–æ–ª—ã<br/>–í—ã–ø–æ–ª–Ω–∏—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ]
    
    K[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç —Ç–µ–∫—Å—Ç] --> L[–ü–∞—Ä—Å–∏–Ω–≥ –≤–≤–æ–¥–∞]
    L --> M{–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–º–≤–æ–ª–æ–≤?}
    M -->|0| N[–û—á–∏—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç<br/>–ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É]
    M -->|1| O{–ï—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª?}
    M -->|2+| P[–û—á–∏—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç<br/>–í—ã–ø–æ–ª–Ω–∏—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ]
    
    O -->|–ù–µ—Ç| Q[–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–∏–º–≤–æ–ª<br/>–ó–∞–ø—Ä–æ—Å–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π]
    O -->|–î–∞| R[–û–±—ä–µ–¥–∏–Ω–∏—Ç—å —Å–∏–º–≤–æ–ª—ã<br/>–í—ã–ø–æ–ª–Ω–∏—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ]
```

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. **–£–ª—É—á—à–µ–Ω–Ω—ã–π UX:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –æ—à–∏–±–∫—É –ø—Ä–∏ —Å–ª—É—á–∞–π–Ω–æ–º –≤–≤–æ–¥–µ –æ–¥–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
2. **–ò–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ—Å—Ç—å:** –ë–æ—Ç –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ
3. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:** –ü–µ—Ä–≤—ã–π —Å–∏–º–≤–æ–ª —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
4. **–ì–∏–±–∫–æ—Å—Ç—å:** –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
5. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** –ù–µ –Ω–∞—Ä—É—à–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

## üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:
- ‚úÖ –ö–æ–¥ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- ‚úÖ –í—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ø–æ–∫—Ä—ã—Ç—ã
- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞

–ö–æ–º–∞–Ω–¥–∞ `/compare` —Ç–µ–ø–µ—Ä—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –±–æ–ª–µ–µ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –ø–æ–∑–≤–æ–ª—è—è –∏–º –≤–≤–æ–¥–∏—Ç—å —Å–∏–º–≤–æ–ª—ã –ø–æ –æ–¥–Ω–æ–º—É –±–µ–∑ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—à–∏–±–æ–∫.
