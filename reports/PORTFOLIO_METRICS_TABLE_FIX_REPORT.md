# –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –æ—à–∏–±–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã –º–µ—Ç—Ä–∏–∫ –ø–æ—Ä—Ç—Ñ–µ–ª—è

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –∫–Ω–æ–ø–∫–∏ "–ú–µ—Ç—Ä–∏–∫–∏" –≤ –∫–æ–º–∞–Ω–¥–µ `/portfolio` –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞:

```
‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –º–µ—Ç—Ä–∏–∫
ERROR - Error creating summary metrics table: [Errno portfolio_5533.PF is not found in the database.] 404
```

## üîç –ü—Ä–∏—á–∏–Ω–∞

–ü—Ä–æ–±–ª–µ–º–∞ –∑–∞–∫–ª—é—á–∞–ª–∞—Å—å –≤ —Ç–æ–º, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è `_create_summary_metrics_table` –ø—ã—Ç–∞–ª–∞—Å—å —Å–æ–∑–¥–∞—Ç—å `ok.AssetList(symbols, ccy=currency)` —Å —Å–∏–º–≤–æ–ª–æ–º –ø–æ—Ä—Ç—Ñ–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, `portfolio_5533.PF`), –Ω–æ –ø–æ—Ä—Ç—Ñ–µ–ª–∏ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –æ–±—ã—á–Ω—ã–º–∏ –∞–∫—Ç–∏–≤–∞–º–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö okama –∏ –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–∞–π–¥–µ–Ω—ã —á–µ—Ä–µ–∑ `ok.AssetList`.

### –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞
- **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `bot.py`, —Å—Ç—Ä–æ–∫–∏ 11098-11115
- **–ü—Ä–æ–±–ª–µ–º–Ω–∞—è –ª–æ–≥–∏–∫–∞**: –ü–µ—Ä–µ–¥–∞—á–∞ —Å–∏–º–≤–æ–ª–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—è –≤ `_create_summary_metrics_table`
- **–û—à–∏–±–∫–∞**: `ok.AssetList(['portfolio_5533.PF'], ccy='RUB')` - –ø–æ—Ä—Ç—Ñ–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è `_create_portfolio_summary_metrics_table`

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `bot.py`, —Å—Ç—Ä–æ–∫–∏ 8217-8376

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å**:
- –°–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É –º–µ—Ç—Ä–∏–∫ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–±—ä–µ–∫—Ç `ok.Portfolio` –≤–º–µ—Å—Ç–æ `ok.AssetList`
- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö `portfolio.wealth_index`
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É –≤ —Ç–æ–º –∂–µ —Ñ–æ—Ä–º–∞—Ç–µ, —á—Ç–æ –∏ `_create_summary_metrics_table`

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏**:
- –°—Ä–µ–¥–Ω–µ–≥–æ–¥–æ–≤–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å (CAGR)
- –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å
- –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –®–∞—Ä–ø–∞
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ—Å–∞–¥–∫–∞
- –ë–µ–∑—Ä–∏—Å–∫–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞
- –°–æ—Å—Ç–∞–≤ –ø–æ—Ä—Ç—Ñ–µ–ª—è

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ú–µ—Ç—Ä–∏–∫–∏" –ø–æ—Ä—Ç—Ñ–µ–ª—è

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `bot.py`, —Å—Ç—Ä–æ–∫–∏ 11117-11125

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
```python
# –°—Ç–∞—Ä—ã–π –∫–æ–¥ (–ü–†–û–ë–õ–ï–ú–ù–´–ô)
summary_table = self._create_summary_metrics_table(
    symbols=[portfolio_symbol], 
    currency=currency, 
    expanded_symbols=expanded_symbols, 
    portfolio_contexts=portfolio_contexts, 
    specified_period=None
)

# –ù–æ–≤—ã–π –∫–æ–¥ (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô)
portfolio = ok.Portfolio(valid_symbols, weights=valid_weights, ccy=currency)
summary_table = self._create_portfolio_summary_metrics_table(
    portfolio, valid_symbols, valid_weights, currency
)
```

### 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è AI-–∞–Ω–∞–ª–∏–∑–∞

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `bot.py`, —Å—Ç—Ä–æ–∫–∏ 14736-14747

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
```python
# –°—Ç–∞—Ä—ã–π –∫–æ–¥ (–ü–†–û–ë–õ–ï–ú–ù–´–ô)
expanded_symbols = [portfolio_symbol]  # Portfolio symbol as single item
data_info = await self._prepare_data_for_analysis([portfolio_symbol], currency, expanded_symbols, portfolio_contexts, user_id)

# –ù–æ–≤—ã–π –∫–æ–¥ (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô)
expanded_symbols = valid_symbols  # Individual assets
data_info = await self._prepare_data_for_analysis(valid_symbols, currency, expanded_symbols, portfolio_contexts, user_id)
```

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞—Å—á–µ—Ç–∞ –º–µ—Ç—Ä–∏–∫

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö**: –ò–∑ `portfolio.wealth_index`
2. **CAGR**: `((final_price / initial_price) ^ (1 / years)) - 1`
3. **–í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å**: `returns.std() * sqrt(12)` (annualized –¥–ª—è –º–µ—Å—è—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
4. **Sharpe Ratio**: `(cagr - risk_free_rate) / volatility`
5. **Max Drawdown**: `min((prices - running_max) / running_max)`

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

- **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö**: –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞–ª–∏—á–∏—è `wealth_index`
- **Fallback –∑–Ω–∞—á–µ–Ω–∏—è**: "N/A" –¥–ª—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Ä–∞—Å—á–µ—Ç–∞
- **Graceful degradation**: –ß–∞—Å—Ç–∏—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### –§–æ—Ä–º–∞—Ç —Ç–∞–±–ª–∏—Ü—ã

```markdown
| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
| :--- | :--- |
| –°—Ä–µ–¥–Ω–µ–≥–æ–¥–æ–≤–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å (CAGR) | 12.34% |
| –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å | 15.67% |
| –ö–æ—ç—Ñ—Ñ. –®–∞—Ä–ø–∞ | 0.789 |
| –ú–∞–∫—Å. –ø—Ä–æ—Å–∞–¥–∫–∞ | -8.90% |
| –ë–µ–∑—Ä–∏—Å–∫–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ | 5.25% |
| –°–æ—Å—Ç–∞–≤ –ø–æ—Ä—Ç—Ñ–µ–ª—è | SBER.MOEX (60.0%), LKOH.MOEX (40.0%) |
```

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç `test_portfolio_metrics_fix.py`

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã**:
```
‚úÖ –§—É–Ω–∫—Ü–∏—è _create_portfolio_summary_metrics_table —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
‚úÖ –¢–∞–±–ª–∏—Ü–∞ –º–µ—Ç—Ä–∏–∫ –ø–æ—Ä—Ç—Ñ–µ–ª—è —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ
‚úÖ –í—Å–µ –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!
```

### –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

1. **–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã**: –£—Å–ø–µ—à–Ω–æ –¥–ª—è –ø–æ—Ä—Ç—Ñ–µ–ª—è SBER.MOEX + LKOH.MOEX
2. **–§–æ—Ä–º–∞—Ç –º–µ—Ç—Ä–∏–∫**: –í—Å–µ –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: Graceful handling –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

## üéØ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

1. **–ö–Ω–æ–ø–∫–∞ "–ú–µ—Ç—Ä–∏–∫–∏"** –≤ `/portfolio` —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –æ—à–∏–±–æ–∫
2. **–¢–∞–±–ª–∏—Ü–∞ –º–µ—Ç—Ä–∏–∫** –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
3. **AI-–∞–Ω–∞–ª–∏–∑** –ø–æ—Ä—Ç—Ñ–µ–ª—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
4. **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** —Å –∫–æ–º–∞–Ω–¥–æ–π `/compare` —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–û—à–∏–±–∫–∞ –±—ã–ª–∞ —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—É—Ç–µ–º:

1. **–°–æ–∑–¥–∞–Ω–∏—è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏** –¥–ª—è –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π
2. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤** okama (Portfolio –≤–º–µ—Å—Ç–æ AssetList)
3. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö** –¥–ª—è AI-–∞–Ω–∞–ª–∏–∑–∞
4. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏** –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞

–¢–µ–ø–µ—Ä—å –∫–æ–º–∞–Ω–¥–∞ `/portfolio` —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –º–µ—Ç—Ä–∏–∫ –∏ AI-–∞–Ω–∞–ª–∏–∑.
