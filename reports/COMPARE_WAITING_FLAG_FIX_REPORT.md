# –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —Ñ–ª–∞–≥–∞ –æ–∂–∏–¥–∞–Ω–∏—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –º—è–≥–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥—ã `/compare` –≤–æ–∑–Ω–∏–∫–ª–∞ –ø—Ä–æ–±–ª–µ–º–∞: –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–ª –∫–Ω–æ–ø–∫—É "–°—Ä–∞–≤–Ω–∏—Ç—å" –∏ –∑–∞—Ç–µ–º –≤–≤–æ–¥–∏–ª –æ–¥–∏–Ω —Å–∏–º–≤–æ–ª, —Å–∏—Å—Ç–µ–º–∞ –≤—ã–ø–æ–ª–Ω—è–ª–∞ –∫–æ–º–∞–Ω–¥—É `/info` –≤–º–µ—Å—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –ª–æ–≥–∏–∫–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è.

**–ü—Ä–∏–º–µ—Ä –ø—Ä–æ–±–ª–µ–º—ã:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–°—Ä–∞–≤–Ω–∏—Ç—å CL.COMM —Å:"
2. –ë–æ—Ç —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `waiting_for_compare=True`
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç `BND.US`
4. **–û—à–∏–±–∫–∞:** –°–∏—Å—Ç–µ–º–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç `/info BND.US` –≤–º–µ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–∏–º–≤–æ–ª–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è

## üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã

### –ù–∞–π–¥–µ–Ω–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞

–ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —Ñ–ª–∞–≥–æ–º `waiting_for_compare`:

1. **–ö–Ω–æ–ø–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:** –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `waiting_for_compare=True`
2. **–ü–µ—Ä–≤—ã–π —Å–∏–º–≤–æ–ª:** –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –Ω–æ `waiting_for_compare` —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –≤ `False`
3. **–í—Ç–æ—Ä–æ–π —Å–∏–º–≤–æ–ª:** –°–∏—Å—Ç–µ–º–∞ –Ω–µ –∑–Ω–∞–µ—Ç —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è, –≤—ã–ø–æ–ª–Ω—è–µ—Ç `/info`

### –õ–æ–≥–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)

```mermaid
graph TD
    A[–ö–Ω–æ–ø–∫–∞ –°—Ä–∞–≤–Ω–∏—Ç—å] --> B[waiting_for_compare=True]
    B --> C[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç —Å–∏–º–≤–æ–ª]
    C --> D[_handle_compare_input]
    D --> E[waiting_for_compare=False]
    E --> F[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –≤—Ç–æ—Ä–æ–π —Å–∏–º–≤–æ–ª]
    F --> G[handle_message –ø—Ä–æ–≤–µ—Ä—è–µ—Ç waiting_for_compare]
    G --> H[waiting_for_compare=False]
    H --> I[–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è /info –≤–º–µ—Å—Ç–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è]
```

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–ª–∞–≥–æ–º waiting_for_compare

**–§–∞–π–ª:** `bot.py` - —Ñ—É–Ω–∫—Ü–∏—è `_handle_compare_input`

#### –ü–µ—Ä–≤—ã–π —Å–∏–º–≤–æ–ª - —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–ª–∞–≥
```python
if len(symbols) == 1:
    if stored_first_symbol is None and compare_base_symbol is None:
        # First symbol - store it and ask for more
        self._update_user_context(user_id, compare_first_symbol=symbols[0], waiting_for_compare=True)
        # Generate random examples for the message
        random_examples = self.get_random_examples(3)
        examples_text = ", ".join([f"`{example}`" for example in random_examples])
        await self._send_message_safe(update, f"–í—ã —É–∫–∞–∑–∞–ª–∏ —Ç–æ–ª—å–∫–æ 1 —Å–∏–º–≤–æ–ª, –∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –Ω—É–∂–Ω–æ 2 –∏ –±–æ–ª—å—à–µ, –Ω–∞–ø–∏—à–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–∏–º–≤–æ–ª –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è, –Ω–∞–ø—Ä–∏–º–µ—Ä {examples_text}")
        return
```

#### –í—Ç–æ—Ä–æ–π —Å–∏–º–≤–æ–ª - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥
```python
else:
    # We have a stored symbol or base symbol, combine with new input
    base_symbol = stored_first_symbol or compare_base_symbol
    combined_symbols = [base_symbol] + symbols
    # Clear both stored symbols and waiting flag
    self._update_user_context(user_id, compare_first_symbol=None, compare_base_symbol=None, waiting_for_compare=False)
    
    # Process the comparison with combined symbols
    context.args = combined_symbols
    context.specified_currency = specified_currency
    context.specified_period = specified_period
    
    await self.compare_command(update, context)
    return
```

### 2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ compare_base_symbol

–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ `compare_base_symbol` –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:

```python
# Check if we have a stored first symbol from previous input or from compare button
stored_first_symbol = user_context.get('compare_first_symbol')
compare_base_symbol = user_context.get('compare_base_symbol')

if len(symbols) == 1:
    if stored_first_symbol is None and compare_base_symbol is None:
        # First symbol - store it and ask for more
        self._update_user_context(user_id, compare_first_symbol=symbols[0], waiting_for_compare=True)
        # ...
    else:
        # We have a stored symbol or base symbol, combine with new input
        base_symbol = stored_first_symbol or compare_base_symbol
        # ...
```

### 3. –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

#### –ü—É—Å—Ç–æ–π –≤–≤–æ–¥
```python
elif len(symbols) == 0:
    # Empty input - clear stored symbols and show help
    self._update_user_context(user_id, compare_first_symbol=None, compare_base_symbol=None, waiting_for_compare=False)
    await self._send_message_safe(update, "‚ùå –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è")
    return
```

#### –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
```python
# We have 2 or more symbols - clear any stored symbols and process normally
self._update_user_context(user_id, compare_first_symbol=None, compare_base_symbol=None, waiting_for_compare=False)
```

## üìã –°—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ö–Ω–æ–ø–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è + –æ–¥–∏–Ω —Å–∏–º–≤–æ–ª
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–°—Ä–∞–≤–Ω–∏—Ç—å CL.COMM —Å:"
2. –ë–æ—Ç —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `compare_base_symbol="CL.COMM"` –∏ `waiting_for_compare=True`
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç `BND.US`
4. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–æ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–∏–º–≤–æ–ª –∏ –ø—Ä–æ—Å–∏—Ç –≤–≤–µ—Å—Ç–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ö–Ω–æ–ø–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è + –≤—Ç–æ—Ä–æ–π —Å–∏–º–≤–æ–ª
1. –ü–æ—Å–ª–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç `SPY.US`
2. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–æ—Ç –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç —Å–∏–º–≤–æ–ª—ã (`CL.COMM SPY.US`) –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –û–±—ã—á–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ /compare
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç `/compare`
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç `AAPL.US`
3. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–æ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–∏–º–≤–æ–ª –∏ –ø—Ä–æ—Å–∏—Ç –≤–≤–µ—Å—Ç–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç `/compare`
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç `AAPL.US MSFT.US`
3. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–æ—Ç –æ—á–∏—â–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç `tests/test_compare_waiting_flag_fix.py` –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:

1. ‚úÖ –ü–µ—Ä–≤—ã–π —Å–∏–º–≤–æ–ª —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç `waiting_for_compare=True`
2. ‚úÖ –í—Ç–æ—Ä–æ–π —Å–∏–º–≤–æ–ª —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç `waiting_for_compare=False`
3. ‚úÖ Base symbol –∏–∑ –∫–Ω–æ–ø–∫–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
4. ‚úÖ –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –æ—á–∏—â–∞—é—Ç —Ñ–ª–∞–≥ –æ–∂–∏–¥–∞–Ω–∏—è

**–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:** 4/4 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ

## üîÑ –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã (–ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)

```mermaid
graph TD
    A[–ö–Ω–æ–ø–∫–∞ –°—Ä–∞–≤–Ω–∏—Ç—å] --> B[compare_base_symbol + waiting_for_compare=True]
    B --> C[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç —Å–∏–º–≤–æ–ª]
    C --> D[_handle_compare_input]
    D --> E{–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–º–≤–æ–ª–æ–≤?}
    E -->|1| F{–ï—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã?}
    E -->|2+| G[–û—á–∏—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç + waiting_for_compare=False]
    E -->|0| H[–û—á–∏—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç + waiting_for_compare=False]
    
    F -->|–ù–µ—Ç| I[–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–∏–º–≤–æ–ª + waiting_for_compare=True]
    F -->|–î–∞| J[–û–±—ä–µ–¥–∏–Ω–∏—Ç—å —Å–∏–º–≤–æ–ª—ã + waiting_for_compare=False]
    
    I --> K[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –≤—Ç–æ—Ä–æ–π —Å–∏–º–≤–æ–ª]
    K --> L[handle_message –ø—Ä–æ–≤–µ—Ä—è–µ—Ç waiting_for_compare]
    L --> M[waiting_for_compare=True]
    M --> N[_handle_compare_input]
    N --> O[–û–±—ä–µ–¥–∏–Ω–∏—Ç—å —Å–∏–º–≤–æ–ª—ã + waiting_for_compare=False]
    O --> P[–í—ã–ø–æ–ª–Ω–∏—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ]
```

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

1. **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞:** –ö–Ω–æ–ø–∫–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ
2. **–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –§–ª–∞–≥ `waiting_for_compare` —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ª–æ–≥–∏—á–Ω–æ
3. **–ò–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ—Å—Ç—å:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –æ–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
4. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:** –í—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –æ—á–∏—Å—Ç–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
5. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** –ù–µ –Ω–∞—Ä—É—à–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

## üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:
- ‚úÖ –ö–æ–¥ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- ‚úÖ –í—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ø–æ–∫—Ä—ã—Ç—ã
- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞

–¢–µ–ø–µ—Ä—å –∫–Ω–æ–ø–∫–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≤ –∫–æ–º–∞–Ω–¥–µ `/info` —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å –ª–æ–≥–∏–∫–æ–π –º—è–≥–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∞–∫—Ç–∏–≤–æ–≤ –±–µ–∑ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –∫ –∫–æ–º–∞–Ω–¥–µ `/info`.
