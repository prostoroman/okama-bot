# Архитектурный рефакторинг и персистентность контекста

## Что сделано

- Введен модуль персистентности контекста `services/context_store.py`:
  - Класс `JSONUserContextStore`: потокобезопасное, JSON‑хранилище пользовательского контекста.
  - Сохраняет ключи `last_assets`, `current_symbols`, `saved_portfolios` и др. между вызовами бота.

- Интеграция с ботом (`bot.py`):
  - `_get_user_context`, `_update_user_context`, `_add_to_conversation_history` переведены на использование `JSONUserContextStore`.
  - Поведение ключей совместимо с существующим кодом (кнопки подтягивают данные из контекста).

- Доменные классы (для переиспользования в веб‑приложениях):
  - `services/domain/asset.py` — класс `Asset` для работы с активом, построение графиков через `chart_styles`.
  - `services/domain/portfolio.py` — класс `Portfolio` (ленивая инициализация, нормализация весов), метод для графика доходности.
  - `services/domain/namespace.py` — класс `Namespace` для работы с namespaces Okama.

- Тесты (`/tests/test_context_store_and_domain.py`):
  - Покрывают создание и обновление контекста, историю диалогов.
  - Smoke‑тесты доменного слоя с моками тяжелых зависимостей.

## Архитектура

- Разделение домена от Telegram‑обвязки: классы `Asset`, `Portfolio`, `Namespace` не зависят от Telegram и могут быть использованы в веб.
- Централизованное хранилище контекста: повторно используемо, потокобезопасно, сериализуемо.
- Единый стиль графиков через `services/chart_styles.py`.

## Совместимость

- Существующие обработчики (например, `/info`, `/compare`, `/portfolio`, `namespace`) продолжают использовать ключи контекста (`current_symbols`, `current_currency` и т.д.).
- Добавлена долговременная персистентность — кнопки подтягивают состояние даже после рестарта процесса.

## Следующие шаги (опционально)

- Постепенная миграция логики из `bot.py` в сервисы/доменные классы по командам.
- Добавить абстракцию хранилища (интерфейс) для смены бэкенда (Redis/DB).

