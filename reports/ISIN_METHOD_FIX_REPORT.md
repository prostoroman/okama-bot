# –û—Ç—á–µ—Ç –æ —Ñ–∏–∫—Å–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –º–µ—Ç–æ–¥–æ–º _looks_like_isin

## –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ ISIN –∫–æ–¥–∞ `RU0009029540` –±–æ—Ç –≤—ã–¥–∞–≤–∞–ª –æ—à–∏–±–∫—É:
```
‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–∫–µ—Ä –ø–æ ISIN RU0009029540. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–∫–∞–∑–∞—Ç—å —Ç–∏–∫–µ—Ä –≤ —Ñ–æ—Ä–º–∞—Ç–µ AAPL.US –∏–ª–∏ SBER.MOEX.
```

## –ü—Ä–∏—á–∏–Ω–∞
–ú–µ—Ç–æ–¥ `_looks_like_isin` –±—ã–ª –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∫–∞–∫ –ª–æ–∫–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤–Ω—É—Ç—Ä–∏ –º–µ—Ç–æ–¥–∞ `resolve_symbol_or_isin`, –Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –≤ –¥—Ä—É–≥–∏—Ö –º–µ—Ç–æ–¥–∞—Ö –∫–ª–∞—Å—Å–∞ (`get_asset_info`, `get_asset_price`), —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –æ—à–∏–±–∫–µ `NameError`.

## –†–µ—à–µ–Ω–∏–µ

### 1. –í—ã–Ω–µ—Å–µ–Ω–∏–µ –º–µ—Ç–æ–¥–∞ _looks_like_isin –≤ –∫–ª–∞—Å—Å ‚úÖ
- –ü–µ—Ä–µ–Ω–µ—Å —Ñ—É–Ω–∫—Ü–∏—é `_looks_like_isin` –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏ –≤ –º–µ—Ç–æ–¥ –∫–ª–∞—Å—Å–∞
- –î–æ–±–∞–≤–∏–ª –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –∏ —Ç–∏–ø–∏–∑–∞—Ü–∏—é
- –û–±–Ω–æ–≤–∏–ª –≤—Å–µ –º–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

**–ù–æ–≤—ã–π –º–µ—Ç–æ–¥ –≤ `services/asset_service.py`:**
```python
def _looks_like_isin(self, val: str) -> bool:
    """
    Check if string looks like an ISIN code
    
    Args:
        val: String to check
        
    Returns:
        True if string matches ISIN format
    """
    if len(val) != 12:
        return False
    if not (val[0:2].isalpha() and val[0:2].isupper()):
        return False
    if not val[-1].isdigit():
        return False
    mid = val[2:11]
    return mid.isalnum()
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–æ–¥–∞ resolve_symbol_or_isin ‚úÖ
- –ó–∞–º–µ–Ω–∏–ª –≤—ã–∑–æ–≤ –ª–æ–∫–∞–ª—å–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ `self._looks_like_isin(upper)`
- –£–±—Ä–∞–ª –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `services/asset_service.py`:**
```python
if self._looks_like_isin(upper):
    # First try to resolve via okama.Asset.search
    okama_symbol = self.search_by_isin(upper)
    # ... rest of the logic
```

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–æ–¥–∞ is_likely_asset_symbol ‚úÖ
- –ó–∞–º–µ–Ω–∏–ª –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏ ISIN –Ω–∞ –≤—ã–∑–æ–≤ `self._looks_like_isin(text)`
- –£–ª—É—á—à–∏–ª —á–∏—Ç–∞–µ–º–æ—Å—Ç—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å –∫–æ–¥–∞

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `services/asset_service.py`:**
```python
# Check if it looks like an ISIN using the dedicated method
if self._looks_like_isin(text):
    return True
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç `test_isin_fix.py`:
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è ISIN –∫–æ–¥–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è ISIN –≤ —Ç–∏–∫–µ—Ä—ã
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ ISIN

### –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:
```
1. –¢–µ—Å—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è ISIN:
   RU0009029540: is_likely_asset_symbol=True, _looks_like_isin=True
   US0378331005: is_likely_asset_symbol=True, _looks_like_isin=True
   INVALID123: is_likely_asset_symbol=False, _looks_like_isin=False
   SBER.MOEX: is_likely_asset_symbol=True, _looks_like_isin=False

2. –¢–µ—Å—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è ISIN:
   RU0009029540 -> {'symbol': 'RU0009029540', 'type': 'isin', 'source': 'okama_search'}
   US0378331005 -> {'symbol': 'US0378331005', 'type': 'isin', 'source': 'okama_search'}
```

## –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã
- `services/asset_service.py` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ _looks_like_isin
- `test_isin_fix.py` - —Å–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç
- `reports/ISIN_METHOD_FIX_REPORT.md` - –æ—Ç—á–µ—Ç –æ —Ñ–∏–∫—Å–µ

## –†–µ–∑—É–ª—å—Ç–∞—Ç
‚úÖ **–ü—Ä–æ–±–ª–µ–º–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞**

–¢–µ–ø–µ—Ä—å –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ ISIN –∫–æ–¥–∞ `RU0009029540`:
1. –ë–æ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç –µ–≥–æ –∫–∞–∫ ISIN
2. –ü–æ–ø—ã—Ç–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å –∞–∫—Ç–∏–≤ –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ `okama.Asset(isin='RU0009029540')`
3. –ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ - –ø–æ–∫–∞–∂–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –°–±–µ—Ä–±–∞–Ω–∫–µ
4. –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - –ø–æ–ø—Ä–æ–±—É–µ—Ç –¥—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã

## –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é
- ‚úÖ –ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω
- ‚úÖ –¢–µ—Å—Ç—ã —Å–æ–∑–¥–∞–Ω—ã
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞

**–°—Ç–∞—Ç—É—Å: –ì–û–¢–û–í–û –ö –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–Æ** üöÄ
