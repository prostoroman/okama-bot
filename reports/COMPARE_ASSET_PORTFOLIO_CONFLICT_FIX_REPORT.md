# –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –º–µ–∂–¥—É –∞–∫—Ç–∏–≤–∞–º–∏ –∏ –ø–æ—Ä—Ç—Ñ–µ–ª—è–º–∏ –≤ –∫–æ–º–∞–Ω–¥–µ compare

## –î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
2025-01-27

## –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ `/compare sber.moex oblg.moex` –æ—Ç–æ–±—Ä–∞–∂–∞–ª—Å—è –≥—Ä–∞—Ñ–∏–∫ —Å –¥–≤—É–º—è –ø–æ—Ä—Ç—Ñ–µ–ª—è–º–∏ –≤–º–µ—Å—Ç–æ –∞–∫—Ç–∏–≤–æ–≤.

### –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞
–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±—ã–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ø–æ—Ä—Ç—Ñ–µ–ª–∏ —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ "sber.moex" –∏ "oblg.moex", –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–≤–ø–∞–¥–∞–ª–∏ —Å —Å–∏–º–≤–æ–ª–∞–º–∏ –∞–∫—Ç–∏–≤–æ–≤. –°–∏—Å—Ç–µ–º–∞ –Ω–∞—Ö–æ–¥–∏–ª–∞ —ç—Ç–∏ —Å–∏–º–≤–æ–ª—ã –≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø–æ—Ä—Ç—Ñ–µ–ª—è—Ö –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∞ –∏—Ö –∫–∞–∫ –ø–æ—Ä—Ç—Ñ–µ–ª–∏, –∞ –Ω–µ –∫–∞–∫ –æ–±—ã—á–Ω—ã–µ –∞–∫—Ç–∏–≤—ã.

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
```python
# –ü—Ä–æ–±–ª–µ–º–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è
saved_portfolios = {
    'sber.moex': {'symbols': ['SBER.MOEX', 'GAZP.MOEX'], 'weights': [0.7, 0.3]},
    'oblg.moex': {'symbols': ['OBLG.MOEX', 'SUGD.MOEX'], 'weights': [0.6, 0.4]}
}

# –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–∏–º–≤–æ–ª–∞ 'sber.moex'
is_portfolio = symbol in saved_portfolios  # True - –Ω–∞–π–¥–µ–Ω –≤ –ø–æ—Ä—Ç—Ñ–µ–ª—è—Ö
# –†–µ–∑—É–ª—å—Ç–∞—Ç: —Å–∏–º–≤–æ–ª –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ –ø–æ—Ä—Ç—Ñ–µ–ª—å –≤–º–µ—Å—Ç–æ –∞–∫—Ç–∏–≤–∞
```

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
–î–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–∏–º–≤–æ–ª–æ–≤ –∞–∫—Ç–∏–≤–æ–≤ –∫–∞–∫ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø–æ—Ä—Ç—Ñ–µ–ª—è—Ö.

### –õ–æ–≥–∏–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
```python
# Check if this is a saved portfolio symbol
is_portfolio = symbol in saved_portfolios

# Additional check: avoid treating asset symbols as portfolios
if is_portfolio and ('.' in symbol and 
    not any(indicator in symbol.upper() for indicator in ['PORTFOLIO_', 'PF_', '.PF', '.pf'])):
    # This looks like an asset symbol, not a portfolio
    is_portfolio = False
```

### –£—Å–ª–æ–≤–∏—è –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
–°–∏–º–≤–æ–ª –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∫–∞–∫ –∞–∫—Ç–∏–≤, –µ—Å–ª–∏:
1. **–°–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ—á–∫—É** (`.`) - —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω–æ –¥–ª—è —Å–∏–º–≤–æ–ª–æ–≤ –∞–∫—Ç–∏–≤–æ–≤
2. **–ù–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –ø–æ—Ä—Ç—Ñ–µ–ª—è**:
   - `PORTFOLIO_`
   - `PF_`
   - `.PF`
   - `.pf`

### –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã
```python
# –°–∏–º–≤–æ–ª—ã –∞–∫—Ç–∏–≤–æ–≤ (–ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –∫–∞–∫ –∞–∫—Ç–∏–≤—ã)
'sber.moex' ‚Üí –∞–∫—Ç–∏–≤ (—Å–æ–¥–µ—Ä–∂–∏—Ç '.', –Ω–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –ø–æ—Ä—Ç—Ñ–µ–ª—è)
'oblg.moex' ‚Üí –∞–∫—Ç–∏–≤ (—Å–æ–¥–µ—Ä–∂–∏—Ç '.', –Ω–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –ø–æ—Ä—Ç—Ñ–µ–ª—è)
'spy.us' ‚Üí –∞–∫—Ç–∏–≤ (—Å–æ–¥–µ—Ä–∂–∏—Ç '.', –Ω–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –ø–æ—Ä—Ç—Ñ–µ–ª—è)

# –°–∏–º–≤–æ–ª—ã –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π (–æ—Å—Ç–∞—é—Ç—Å—è –ø–æ—Ä—Ç—Ñ–µ–ª—è–º–∏)
'PORTFOLIO_1' ‚Üí –ø–æ—Ä—Ç—Ñ–µ–ª—å (—Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä 'PORTFOLIO_')
'PF_2' ‚Üí –ø–æ—Ä—Ç—Ñ–µ–ª—å (—Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä 'PF_')
'portfolio_123.PF' ‚Üí –ø–æ—Ä—Ç—Ñ–µ–ª—å (—Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä '.PF')
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
1. **test_asset_symbols_with_dots_not_treated_as_portfolios** - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —Å–∏–º–≤–æ–ª—ã –∞–∫—Ç–∏–≤–æ–≤ —Å —Ç–æ—á–∫–∞–º–∏ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–∞–∫ –ø–æ—Ä—Ç—Ñ–µ–ª–∏
2. **test_portfolio_symbols_with_indicators_treated_as_portfolios** - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —Å–∏–º–≤–æ–ª—ã –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–∞–∫ –ø–æ—Ä—Ç—Ñ–µ–ª–∏
3. **test_mixed_symbols_processing** - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–º–µ—à–∞–Ω–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
4. **test_case_insensitive_handling** - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É —Ä–µ–≥–∏—Å—Ç—Ä–∞ —Å–∏–º–≤–æ–ª–æ–≤

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
```
Ran 4 tests in 0.007s
OK
```

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç
–°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç `scripts/debug_compare_issue.py` –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º —Å –∫–æ–º–∞–Ω–¥–æ–π compare.

## –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
```
/compare sber.moex oblg.moex
‚Üí –°–∏–º–≤–æ–ª—ã –Ω–∞–π–¥–µ–Ω—ã –≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø–æ—Ä—Ç—Ñ–µ–ª—è—Ö
‚Üí –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–∞–∫ –ø–æ—Ä—Ç—Ñ–µ–ª–∏
‚Üí –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≥—Ä–∞—Ñ–∏–∫ —Å –¥–≤—É–º—è –ø–æ—Ä—Ç—Ñ–µ–ª—è–º–∏
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
```
/compare sber.moex oblg.moex
‚Üí –°–∏–º–≤–æ–ª—ã –Ω–∞–π–¥–µ–Ω—ã –≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø–æ—Ä—Ç—Ñ–µ–ª—è—Ö
‚Üí –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: —Å–∏–º–≤–æ–ª—ã —Å–æ–¥–µ—Ä–∂–∞—Ç '.' –∏ –Ω–µ –∏–º–µ—é—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –ø–æ—Ä—Ç—Ñ–µ–ª—è
‚Üí –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –∫–∞–∫ –∞–∫—Ç–∏–≤—ã
‚Üí –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≥—Ä–∞—Ñ–∏–∫ —Å –¥–≤—É–º—è –∞–∫—Ç–∏–≤–∞–º–∏
```

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
- `bot.py` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ª–æ–≥–∏–∫—É –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π
- `tests/test_asset_portfolio_conflict_fix.py` - —Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- `scripts/debug_compare_issue.py` - –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç

### –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏
```python
def is_asset_symbol(symbol):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–∏–º–≤–æ–ª –∞–∫—Ç–∏–≤–æ–º, –∞ –Ω–µ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–º"""
    return ('.' in symbol and 
            not any(indicator in symbol.upper() 
                   for indicator in ['PORTFOLIO_', 'PF_', '.PF', '.pf']))
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### ‚úÖ –î–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–µ —Ü–µ–ª–∏
1. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞** —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –∞–∫—Ç–∏–≤–æ–≤ –∫–∞–∫ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π
2. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –ø–æ—Ä—Ç—Ñ–µ–ª—è–º–∏
3. **–î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç—ã** –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ä–µ–≥—Ä–µ—Å—Å–∏–π
4. **–°–æ–∑–¥–∞–Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞** –¥–ª—è –±—É–¥—É—â–∏—Ö –ø—Ä–æ–±–ª–µ–º

### üéØ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç
- –ö–æ–º–∞–Ω–¥–∞ `/compare sber.moex oblg.moex` —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∞–∫—Ç–∏–≤—ã
- –ü–æ—Ä—Ç—Ñ–µ–ª–∏ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- –°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–ª–∞ –±–æ–ª–µ–µ –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ–π –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–π

### üîß –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
1. **–ò–∑–±–µ–≥–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π** —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏, —Å–æ–≤–ø–∞–¥–∞—é—â–∏–º–∏ —Å —Å–∏–º–≤–æ–ª–∞–º–∏ –∞–∫—Ç–∏–≤–æ–≤
2. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π** –≤ –Ω–∞–∑–≤–∞–Ω–∏—è—Ö (PORTFOLIO_, PF_, .PF)
3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É compare** —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –∫–æ–º–±–∏–Ω–∞—Ü–∏—è–º–∏ —Å–∏–º–≤–æ–ª–æ–≤
