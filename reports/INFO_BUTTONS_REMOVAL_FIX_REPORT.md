# Отчет об исправлении удаления кнопок в команде /info

## Задача

Исправить проблему с кнопками команды `/info`, которые не исчезали со старых сообщений при отправке новых сообщений.

## Проблема

При нажатии на любые кнопки в команде `/info` (переключение периодов, анализ рисков, метрики, AI-анализ, сравнение, портфель) создавались новые сообщения с результатами, но кнопки оставались на старых сообщениях, что создавало путаницу для пользователей.

## Решение

### Изменения в коде

**Файл**: `bot.py`  
**Функции**: 
- `_handle_okama_info_period_button()` (строки 7267-7301)
- `_handle_tushare_info_period_button()` (строки 7303-7345)
- `_handle_info_risks_button()` (строки 7348-7410)
- `_handle_info_metrics_button()` (строки 7411-7478)
- `_handle_info_ai_analysis_button()` (строки 7480-7518)
- `_handle_info_compare_button()` (строки 7520-7550)
- `_handle_info_portfolio_button()` (строки 7553-7583)

#### Добавлен код для удаления кнопок со старого сообщения во всех функциях:

```python
# Remove buttons from the old message
try:
    await update.callback_query.edit_message_reply_markup(reply_markup=None)
except Exception as e:
    self.logger.warning(f"Could not remove buttons from old message: {e}")
```

### Детальные изменения

#### 1. Функция `_handle_okama_info_period_button()`

**Добавлено в начало функции:**
- Удаление кнопок со старого сообщения перед получением данных за новый период
- Обработка ошибок при удалении кнопок

**Логика работы:**
1. Удаляются кнопки со старого сообщения
2. Получаются данные актива за новый период
3. Отправляется новое сообщение с графиком и кнопками

#### 2. Функция `_handle_tushare_info_period_button()`

**Добавлено в начало функции:**
- Удаление кнопок со старого сообщения перед получением данных Tushare
- Обработка ошибок при удалении кнопок

**Логика работы:**
1. Удаляются кнопки со старого сообщения
2. Проверяется доступность сервиса Tushare
3. Получаются данные актива за новый период
4. Отправляется новое сообщение с графиком и кнопками

#### 3. Функция `_handle_info_risks_button()`

**Добавлено в начало функции:**
- Удаление кнопок со старого сообщения перед анализом рисков
- Обработка ошибок при удалении кнопок

**Логика работы:**
1. Удаляются кнопки со старого сообщения
2. Показывается временное сообщение о загрузке
3. Выполняется анализ рисков
4. Отправляется новое сообщение с результатами

#### 4. Функция `_handle_info_metrics_button()`

**Добавлено в начало функции:**
- Удаление кнопок со старого сообщения перед получением метрик
- Обработка ошибок при удалении кнопок

**Логика работы:**
1. Удаляются кнопки со старого сообщения
2. Показывается временное сообщение о загрузке
3. Получаются все метрики актива
4. Отправляется новое сообщение с результатами

#### 5. Функция `_handle_info_ai_analysis_button()`

**Добавлено в начало функции:**
- Удаление кнопок со старого сообщения перед AI-анализом
- Обработка ошибок при удалении кнопок

**Логика работы:**
1. Удаляются кнопки со старого сообщения
2. Показывается временное сообщение о загрузке
3. Выполняется AI-анализ
4. Отправляется новое сообщение с результатами

#### 6. Функция `_handle_info_compare_button()`

**Добавлено в начало функции:**
- Удаление кнопок со старого сообщения перед подготовкой сравнения
- Обработка ошибок при удалении кнопок

**Логика работы:**
1. Удаляются кнопки со старого сообщения
2. Устанавливается контекст ожидания ввода для сравнения
3. Отправляется новое сообщение с инструкциями

#### 7. Функция `_handle_info_portfolio_button()`

**Добавлено в начало функции:**
- Удаление кнопок со старого сообщения перед подготовкой портфеля
- Обработка ошибок при удалении кнопок

**Логика работы:**
1. Удаляются кнопки со старого сообщения
2. Устанавливается контекст ожидания ввода для портфеля
3. Отправляется новое сообщение с инструкциями

### Обработка ошибок

Во всех функциях добавлена обработка ошибок при удалении кнопок:
- Если удаление кнопок не удается, ошибка логируется как предупреждение
- Выполнение функции продолжается без прерывания
- Пользователь получает результат, даже если кнопки не удалились

### Результат

После исправления:
- ✅ Кнопки исчезают со старых сообщений при нажатии
- ✅ Новые сообщения отправляются без дублирования кнопок
- ✅ Интерфейс стал более чистым и понятным
- ✅ Обработка ошибок предотвращает сбои

### Тестирование

Для проверки исправления:
1. Выполните команду `/info AAPL.US`
2. Нажмите на любую кнопку (1Y, 5Y, Max, Риски, Метрики, AI-анализ, Сравнить, В Портфель)
3. Убедитесь, что кнопки исчезли со старого сообщения
4. Убедитесь, что новое сообщение содержит только текст или график без кнопок (кроме кнопок переключения периодов)

## Статус

✅ **ИСПРАВЛЕНО** - Все кнопки команды `/info` теперь корректно удаляются со старых сообщений при отправке новых.
