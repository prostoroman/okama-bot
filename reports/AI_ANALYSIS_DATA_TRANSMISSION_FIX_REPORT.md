# –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö –≤ AI –∞–Ω–∞–ª–∏–∑

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã `/compare SBER.MOEX LKOH.MOEX RUB 5Y` –∏ –ø–æ—Å–ª–µ–¥—É—é—â–µ–º –∞–Ω–∞–ª–∏–∑–µ —á–µ—Ä–µ–∑ Gemini AI, –∞–Ω–∞–ª–∏–∑ –≤–æ–∑–≤—Ä–∞—â–∞–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –Ω—É–ª–µ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫:

```
–í–∞–∂–Ω–æ –æ—Ç–º–µ—Ç–∏—Ç—å, —á—Ç–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –æ–±—â–µ–π –∏ –≥–æ–¥–æ–≤–æ–π –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏, –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏, –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ –®–∞—Ä–ø–∞ –∏ –°–æ—Ä—Ç–∏–Ω–æ —Ä–∞–≤–Ω—ã –Ω—É–ª—é, —á—Ç–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –æ—à–∏–±–∫—É –≤ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ.
```

## üîç –ü—Ä–∏—á–∏–Ω–∞

–ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `_prepare_data_for_analysis` (—Å—Ç—Ä–æ–∫–∏ 6568-6810), –≥–¥–µ –∫–æ–¥ –ø—ã—Ç–∞–ª—Å—è –ø–æ–ª—É—á–∏—Ç—å –∞—Ç—Ä–∏–±—É—Ç—ã –∏–∑ —Å—Ç—Ä–æ–∫ —Å–∏–º–≤–æ–ª–æ–≤ –≤–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ `ok.Asset`:

1. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ `expanded_symbols`**: –î–ª—è –æ–±—ã—á–Ω—ã—Ö –∞–∫—Ç–∏–≤–æ–≤ (–Ω–µ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π) –≤ `expanded_symbols` —Ö—Ä–∞–Ω—è—Ç—Å—è —Å—Ç—Ä–æ–∫–∏ —Å–∏–º–≤–æ–ª–æ–≤, –∞ –Ω–µ –æ–±—ä–µ–∫—Ç—ã `ok.Asset`
2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ Asset**: –ö–æ–¥ –ø—ã—Ç–∞–ª—Å—è –ø–æ–ª—É—á–∏—Ç—å –∞—Ç—Ä–∏–±—É—Ç—ã (`close_monthly`, `close_daily`, `adj_close`) –Ω–∞–ø—Ä—è–º—É—é –∏–∑ —Å—Ç—Ä–æ–∫
3. **–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∏–ø–æ–≤**: –ö–æ–¥ –Ω–µ —Ä–∞–∑–ª–∏—á–∞–ª –ø–æ—Ä—Ç—Ñ–µ–ª–∏ (DataFrame/Series) –∏ –æ–±—ã—á–Ω—ã–µ –∞–∫—Ç–∏–≤—ã (—Å—Ç—Ä–æ–∫–∏)

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∞–∫—Ç–∏–≤–æ–≤

**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```python
if i < len(expanded_symbols):
    asset_data = expanded_symbols[i]  # –≠—Ç–æ —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –∞–∫—Ç–∏–≤–æ–≤!
    
    # –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å –∞—Ç—Ä–∏–±—É—Ç—ã –∏–∑ —Å—Ç—Ä–æ–∫–∏
    if hasattr(asset_data, 'close_monthly') and asset_data.close_monthly is not None:
        prices = asset_data.close_monthly  # –û–®–ò–ë–ö–ê!
```

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```python
if i < len(expanded_symbols):
    expanded_item = expanded_symbols[i]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö
    if isinstance(expanded_item, (pd.Series, pd.DataFrame)):
        # –≠—Ç–æ –ø–æ—Ä—Ç—Ñ–µ–ª—å - –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ä–µ–∫—Ç –ø–æ—Ä—Ç—Ñ–µ–ª—è
        if i < len(portfolio_contexts):
            portfolio_context = portfolio_contexts[i]
            asset_data = portfolio_context.get('portfolio_object')
    else:
        # –≠—Ç–æ –æ–±—ã—á–Ω—ã–π –∞–∫—Ç–∏–≤ - —Å–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç Asset
        try:
            asset_data = ok.Asset(symbol)
        except Exception as e:
            self.logger.warning(f"Failed to create Asset object for {symbol}: {e}")
            asset_data = None
```

### 2. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ None

–í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞—Ç—Ä–∏–±—É—Ç–æ–≤ —Ç–µ–ø–µ—Ä—å –≤–∫–ª—é—á–∞—é—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ `None`:

```python
if asset_data is not None and hasattr(asset_data, 'close_monthly') and asset_data.close_monthly is not None:
    prices = asset_data.close_monthly
    data_type = "monthly"
```

### 3. –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

–î–æ–±–∞–≤–ª–µ–Ω—ã fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã –¥–ª—è —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ –Ω–µ —É–¥–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å –æ–±—ä–µ–∫—Ç Asset:

```python
# Fallback: try to create Asset from symbol if we don't have asset_data
if asset_data is None:
    try:
        asset_data = ok.Asset(symbol)
    except Exception as e:
        self.logger.warning(f"Failed to create Asset object for {symbol}: {e}")
        asset_data = None
```

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏—è `_prepare_data_for_analysis` —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:

1. **–°–æ–∑–¥–∞–µ—Ç –æ–±—ä–µ–∫—Ç—ã `ok.Asset`** –¥–ª—è —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –∞–∫—Ç–∏–≤–æ–≤ (SBER.MOEX, LKOH.MOEX)
2. **–ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** –æ —Ü–µ–Ω–∞—Ö –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ okama
3. **–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏**:
   - CAGR (—Å—Ä–µ–¥–Ω–µ–≥–æ–¥–æ–≤–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å)
   - –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å
   - –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –®–∞—Ä–ø–∞
   - –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –°–æ—Ä—Ç–∏–Ω–æ
   - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ—Å–∞–¥–∫–∞
   - VaR 95% –∏ CVaR 95%

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- `_prepare_data_for_analysis()` - –æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è AI –∞–Ω–∞–ª–∏–∑–∞

### –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
1. **–ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–∞–∑–ª–∏—á–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö**: –ø–æ—Ä—Ç—Ñ–µ–ª–∏ vs –æ–±—ã—á–Ω—ã–µ –∞–∫—Ç–∏–≤—ã
2. **–°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ Asset**: –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–∏–º–≤–æ–ª–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –æ–±—ä–µ–∫—Ç
3. **–£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
4. **–ü—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ None**: –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏ –∑–∞—â–∏—â–µ–Ω—ã –æ—Ç None

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–∏–ø—ã –∞–∫—Ç–∏–≤–æ–≤
- **–û–±—ã—á–Ω—ã–µ –∞–∫—Ç–∏–≤—ã**: SBER.MOEX, LKOH.MOEX, SPY.US, QQQ.US
- **–ü–æ—Ä—Ç—Ñ–µ–ª–∏**: —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É `/portfolio`
- **–°–º–µ—à–∞–Ω–Ω—ã–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è**: –∞–∫—Ç–∏–≤—ã + –ø–æ—Ä—Ç—Ñ–µ–ª–∏

## üéØ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–¢–µ–ø–µ—Ä—å –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã `/compare SBER.MOEX LKOH.MOEX RUB 5Y` –∏ –ø–æ—Å–ª–µ–¥—É—é—â–µ–º –∞–Ω–∞–ª–∏–∑–µ —á–µ—Ä–µ–∑ Gemini AI:

1. **–î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏**: —Ä–µ–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –≤–º–µ—Å—Ç–æ –Ω—É–ª–µ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
2. **–ê–Ω–∞–ª–∏–∑ –±—É–¥–µ—Ç —Ç–æ—á–Ω—ã–º**: Gemini –ø–æ–ª—É—á–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
3. **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –±—É–¥—É—Ç –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–º–∏**: –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–º–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è—Ö

## üìù –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å –∫–æ–º–∞–Ω–¥–∞–º–∏:
- `/compare SBER.MOEX LKOH.MOEX RUB 5Y`
- `/compare SPY.US QQQ.US USD 10Y`
- `/compare SBER.MOEX SPY.US USD 5Y`

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "–ê–Ω–∞–ª–∏–∑ Gemini" –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∞–Ω–∞–ª–∏–∑ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –≤–º–µ—Å—Ç–æ –Ω—É–ª–µ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π.
