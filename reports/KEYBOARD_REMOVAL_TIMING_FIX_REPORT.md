# –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —Ç–∞–π–º–∏–Ω–≥–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

**–°–∏–º–ø—Ç–æ–º**: –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–µ—Ä–µ—Å—Ç–∞–ª–∞ —É–¥–∞–ª—è—Ç—å—Å—è —Å –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–æ–∫ –∫–æ–º–∞–Ω–¥—ã `/compare`.

**–ü—Ä–∏—á–∏–Ω–∞**: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∞–π–º–∏–Ω–≥ —É–¥–∞–ª–µ–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã. –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —É–¥–∞–ª—è–ª–∞—Å—å **–ø–æ—Å–ª–µ** –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–æ –ø–æ—Å–∫–æ–ª—å–∫—É `_send_callback_message` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–∞ –Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ), –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –æ—Å—Ç–∞–≤–∞–ª–∞—Å—å –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏.

## üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã

### –ò—Å—Ö–æ–¥–Ω–∞—è –ª–æ–≥–∏–∫–∞ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è):
```python
# 1. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
await self._send_callback_message(update, context, text, reply_markup=keyboard)

# 2. –ü—ã—Ç–∞–µ–º—Å—è —É–¥–∞–ª–∏—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
await self._remove_keyboard_after_successful_message(update, context)
```

**–ü—Ä–æ–±–ª–µ–º–∞**: `_send_callback_message` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç **–Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ**, –∞ –Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ. –ü–æ—ç—Ç–æ–º—É –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏.

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞:
```python
# 1. –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
await self._remove_keyboard_before_new_message(update, context)

# 2. –ó–∞—Ç–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
await self._send_callback_message(update, context, text, reply_markup=keyboard)
```

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ç–∞–π–º–∏–Ω–≥–∞

```python
async def _remove_keyboard_before_new_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–£–¥–∞–ª–∏—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è"""
    try:
        if hasattr(update, 'callback_query') and update.callback_query is not None:
            await update.callback_query.edit_message_reply_markup(reply_markup=None)
            self.logger.info("Successfully removed keyboard from previous message before sending new message")
    except Exception as e:
        self.logger.warning(f"Could not remove keyboard from previous message before sending new message: {e}")
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –∫–æ–º–∞–Ω–¥—ã `/compare`

#### –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å `context.bot.send_photo`:
- ‚úÖ `_handle_risk_return_compare_button`
- ‚úÖ `_handle_efficient_frontier_compare_button`

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ**:
```python
# –î–û:
await context.bot.send_photo(...)
await self._remove_keyboard_after_successful_message(update, context)

# –ü–û–°–õ–ï:
await self._remove_keyboard_before_new_message(update, context)
await context.bot.send_photo(...)
```

#### –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å `_send_callback_message`:
- ‚úÖ `_handle_data_analysis_compare_button`
- ‚úÖ `_handle_yandexgpt_analysis_compare_button`
- ‚úÖ `_handle_chart_analysis_compare_button`
- ‚úÖ `_handle_metrics_compare_button`

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ**:
```python
# –î–û:
await self._send_callback_message(update, context, text, reply_markup=keyboard)
await self._remove_keyboard_after_successful_message(update, context)

# –ü–û–°–õ–ï:
await self._remove_keyboard_before_new_message(update, context)
await self._send_callback_message(update, context, text, reply_markup=keyboard)
```

### 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

–°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç `scripts/fix_keyboard_removal_timing.py` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤:

```python
#!/usr/bin/env python3
"""
Script to fix keyboard removal timing in bot.py
This script will update all handlers to remove keyboard before sending new messages instead of after.
"""
```

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–∏:

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ callback query**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É
2. **–£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã**: `_remove_keyboard_before_new_message` —É–¥–∞–ª—è–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
3. **–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è**: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –Ω–æ–≤–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
4. **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π

### –¢–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∏—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∞:

#### `context.bot.send_photo` (–≥—Ä–∞—Ñ–∏–∫–∏):
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
- –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —É–¥–∞–ª—è–µ—Ç—Å—è **–¥–æ** –æ—Ç–ø—Ä–∞–≤–∫–∏
- –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–æ–≤—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É

#### `_send_callback_message` (—Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è):
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —É–¥–∞–ª—è–µ—Ç—Å—è **–¥–æ** –æ—Ç–ø—Ä–∞–≤–∫–∏
- –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–æ–≤—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É

#### `context.bot.send_document` (Excel —Ñ–∞–π–ª—ã):
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –¥–æ–∫—É–º–µ–Ω—Ç–æ–º
- –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —É–¥–∞–ª—è–µ—Ç—Å—è **–¥–æ** –æ—Ç–ø—Ä–∞–≤–∫–∏
- –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–æ–≤—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚ùå –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –Ω–µ —É–¥–∞–ª—è–ª–∞—Å—å —Å –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–µ–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞–º–∏
- ‚ùå –ü—É—Ç–∞–Ω–∏—Ü–∞ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —É–¥–∞–ª—è–µ—Ç—Å—è —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
- ‚úÖ –ß–∏—Å—Ç—ã–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:

1. **–ù–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ Risk/Return**:
   - ‚úÖ –°—Ç–∞—Ä–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —É–¥–∞–ª—è–µ—Ç—Å—è
   - ‚úÖ –ù–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
   - ‚úÖ –¢–æ–ª—å–∫–æ –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π –≤–∏–¥–Ω–æ

2. **–ù–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö**:
   - ‚úÖ –°—Ç–∞—Ä–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —É–¥–∞–ª—è–µ—Ç—Å—è
   - ‚úÖ –ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
   - ‚úÖ –¢–æ–ª—å–∫–æ –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π –≤–∏–¥–Ω–æ

3. **–ù–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ –º–µ—Ç—Ä–∏–∫**:
   - ‚úÖ –°—Ç–∞—Ä–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —É–¥–∞–ª—è–µ—Ç—Å—è
   - ‚úÖ –ù–æ–≤—ã–π Excel —Ñ–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
   - ‚úÖ –¢–æ–ª—å–∫–æ –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π –≤–∏–¥–Ω–æ

## üìã –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### `_remove_keyboard_before_new_message`
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –£–¥–∞–ª–µ–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –°–æ–∑–¥–∞–Ω–∞

### –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏:
- ‚úÖ `_handle_risk_return_compare_button`
- ‚úÖ `_handle_efficient_frontier_compare_button`
- ‚úÖ `_handle_data_analysis_compare_button`
- ‚úÖ `_handle_yandexgpt_analysis_compare_button`
- ‚úÖ `_handle_chart_analysis_compare_button`
- ‚úÖ `_handle_metrics_compare_button`

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

- ‚úÖ –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã
- ‚úÖ –û—à–∏–±–∫–∏ –ª–∏–Ω—Ç–µ—Ä–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
- ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∫–æ–º–º–∏—Ç—É –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–∏–Ω–≥–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —É—Å–ø–µ—à–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ. –¢–µ–ø–µ—Ä—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —É–¥–∞–ª—è–µ—Ç—Å—è **–ø–µ—Ä–µ–¥** –æ—Ç–ø—Ä–∞–≤–∫–æ–π –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è, —á—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∏ —á–∏—Å—Ç—ã–π UX.

**–°—Ç–∞—Ç—É—Å**: üü¢ **–ò–°–ü–†–ê–í–õ–ï–ù–û –£–°–ü–ï–®–ù–û**

–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —É–¥–∞–ª—è–µ—Ç—Å—è —Å –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–æ–∫ –∫–æ–º–∞–Ω–¥—ã `/compare`.
