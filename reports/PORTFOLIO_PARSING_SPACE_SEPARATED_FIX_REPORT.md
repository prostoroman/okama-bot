# –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—è —Å –ø—Ä–æ–±–µ–ª–∞–º–∏

## –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—ã—Ç–∞–ª—Å—è –¥–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤—ã –≤ –ø–æ—Ä—Ç—Ñ–µ–ª—å, –∏—Å–ø–æ–ª—å–∑—É—è —Ñ–æ—Ä–º–∞—Ç —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ –≤–º–µ—Å—Ç–æ –∑–∞–ø—è—Ç—ã—Ö:

```
SBER.MOEX:0.4 LKOH.MOEX:0.3 LQDT.MOEX:0.3
```

–ë–æ—Ç –≤—ã–¥–∞–≤–∞–ª –æ—à–∏–±–∫—É:
```
‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –Ω–∏ –æ–¥–Ω–æ–≥–æ –∞–∫—Ç–∏–≤–∞.

üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏:
‚Ä¢ –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–æ–ª—è '0.4 LKOH.MOEX:0.3 LQDT.MOEX:0.3' –¥–ª—è SBER.MOEX. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —á–∏—Å–ª–∞ –æ—Ç 0 –¥–æ 1.
```

## –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã

–§—É–Ω–∫—Ü–∏—è `smart_parse_portfolio_input()` –±—ã–ª–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—è—Ç—ã—Ö –∫–∞–∫ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π –º–µ–∂–¥—É –∞–∫—Ç–∏–≤–∞–º–∏. –ü—Ä–∏ –≤–≤–æ–¥–µ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ —Å–∏—Å—Ç–µ–º–∞ –ø—ã—Ç–∞–ª–∞—Å—å –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å —Ç–µ–∫—Å—Ç –∫–∞–∫ –æ–¥–∏–Ω –∞–∫—Ç–∏–≤ —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –≤–µ—Å–æ–º.

### –ò—Å—Ö–æ–¥–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:
1. –ó–∞–º–µ–Ω—è–ª–∞ –∑–∞–ø—è—Ç—ã–µ –≤ —á–∏—Å–ª–∞—Ö –Ω–∞ —Ç–æ—á–∫–∏ (–¥–ª—è —Ä—É—Å—Å–∫–æ–π –ª–æ–∫–∞–ª–∏)
2. –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–ª–∞ –ø—Ä–æ–±–µ–ª—ã –≤–æ–∫—Ä—É–≥ –∑–∞–ø—è—Ç—ã—Ö –∏ –¥–≤–æ–µ—Ç–æ—á–∏–π
3. –†–∞–∑–¥–µ–ª—è–ª–∞ —Ç–æ–ª—å–∫–æ –ø–æ –∑–∞–ø—è—Ç—ã–º: `cleaned_text.split(',')`

### –ü—Ä–æ–±–ª–µ–º–∞:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –ø—Ä–æ–±–µ–ª—ã –∫–∞–∫ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏
- –°–∏—Å—Ç–µ–º–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–ª–∞ –ø—Ä–æ–±–µ–ª—ã –∫–∞–∫ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ –∞–∫—Ç–∏–≤–æ–≤
- –í–µ—Å—å –≤–≤–æ–¥ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞–ª—Å—è –∫–∞–∫ –æ–¥–∏–Ω –∞–∫—Ç–∏–≤

## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### 1. –£–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è

–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–æ–±–µ–ª–æ–≤ –∫–∞–∫ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π –∞–∫—Ç–∏–≤–æ–≤:

```python
# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å: –µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–ø—è—Ç—ã–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö, –∏–Ω–∞—á–µ –ø—Ä–æ–±–µ–ª—ã
if ',' in cleaned_text:
    # –†–∞–∑–±–∏–≤–∞–µ–º –ø–æ –∑–∞–ø—è—Ç—ã–º
    parts = [part.strip() for part in cleaned_text.split(',') if part.strip()]
else:
    # –†–∞–∑–±–∏–≤–∞–µ–º –ø–æ –ø—Ä–æ–±–µ–ª–∞–º —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π
    pattern = r'([A-Za-z0-9._]+:\d+(?:\.\d+)?)'
    matches = re.findall(pattern, cleaned_text)
    # ... –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–æ–±–µ–ª–æ–≤
```

### 2. –£–º–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ "—Å–∏–º–≤–æ–ª:—á–∏—Å–ª–æ":
- `([A-Za-z0-9._]+:\d+(?:\.\d+)?)` - –Ω–∞—Ö–æ–¥–∏—Ç –∞–∫—Ç–∏–≤—ã —Å –≤–µ—Å–∞–º–∏
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–∏–º–≤–æ–ª—ã –±–µ–∑ –≤–µ—Å–æ–≤ –æ—Ç–¥–µ–ª—å–Ω–æ
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ—Ä—è–¥–æ–∫ –∞–∫—Ç–∏–≤–æ–≤

### 3. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–º–µ—à–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤

–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:
- **–¢–æ–ª—å–∫–æ –ø—Ä–æ–±–µ–ª—ã**: `SBER.MOEX:0.4 LKOH.MOEX:0.3 LQDT.MOEX:0.3`
- **–¢–æ–ª—å–∫–æ –∑–∞–ø—è—Ç—ã–µ**: `SBER.MOEX:0.4, LKOH.MOEX:0.3, LQDT.MOEX:0.3`
- **–°–º–µ—à–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç**: `SBER.MOEX:0.4 LKOH.MOEX LQDT.MOEX:0.3`

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

–í —Ñ–∞–π–ª–µ `tests/test_data_consistency_fixes.py` –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç—ã:

1. **`test_space_separated_portfolio`** - –±–∞–∑–æ–≤—ã–π —Ç–µ—Å—Ç —Å –ø—Ä–æ–±–µ–ª–∞–º–∏
2. **`test_space_separated_with_extra_spaces`** - —Ç–µ—Å—Ç —Å –ª–∏—à–Ω–∏–º–∏ –ø—Ä–æ–±–µ–ª–∞–º–∏
3. **`test_space_separated_mixed_with_symbols_only`** - —Å–º–µ—à–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
4. **`test_space_separated_with_comma_numbers`** - —Ä—É—Å—Å–∫–∞—è –ª–æ–∫–∞–ª—å (–∑–∞–ø—è—Ç—ã–µ –≤ —á–∏—Å–ª–∞—Ö)
5. **`test_comma_separated_still_works`** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

```bash
$ python3 tests/test_data_consistency_fixes.py
.....
----------------------------------------------------------------------
Ran 5 tests in 0.012s

OK
```

–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ.

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

```bash
$ python3 tests/test_smart_portfolio_parsing.py
...........
----------------------------------------------------------------------
Ran 12 tests in 0.028s

OK
```

–í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.

## –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
–í–≤–æ–¥: SBER.MOEX:0.4 LKOH.MOEX:0.3 LQDT.MOEX:0.3
–†–µ–∑—É–ª—å—Ç–∞—Ç: ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –Ω–∏ –æ–¥–Ω–æ–≥–æ –∞–∫—Ç–∏–≤–∞
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
–í–≤–æ–¥: SBER.MOEX:0.4 LKOH.MOEX:0.3 LQDT.MOEX:0.3
–†–µ–∑—É–ª—å—Ç–∞—Ç: ‚úÖ –ü–æ—Ä—Ç—Ñ–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω:
‚Ä¢ SBER.MOEX: 0.400
‚Ä¢ LKOH.MOEX: 0.300
‚Ä¢ LQDT.MOEX: 0.300
```

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:

1. **–° –ª–∏—à–Ω–∏–º–∏ –ø—Ä–æ–±–µ–ª–∞–º–∏**:
   ```
   SBER.MOEX:0.4  LKOH.MOEX:0.3   LQDT.MOEX:0.3
   ```

2. **–°–º–µ—à–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç**:
   ```
   SBER.MOEX:0.4 LKOH.MOEX LQDT.MOEX:0.3
   ```

3. **–†—É—Å—Å–∫–∞—è –ª–æ–∫–∞–ª—å**:
   ```
   SBER.MOEX:0,4 LKOH.MOEX:0,3 LQDT.MOEX:0,3
   ```

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- `bot.py` - –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞
- `tests/test_data_consistency_fixes.py` - –Ω–æ–≤—ã–µ —Ç–µ—Å—Ç—ã

### –ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- `smart_parse_portfolio_input()` - —É–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞
- –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∞–∫—Ç–∏–≤–æ–≤
- –£–º–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ø—Ä–æ–±–µ–ª–∞–º –∏ –∑–∞–ø—è—Ç—ã–º

### –ê–ª–≥–æ—Ä–∏—Ç–º:
1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è (–∑–∞–ø—è—Ç—ã–µ –∏–ª–∏ –ø—Ä–æ–±–µ–ª—ã)
2. –ü–æ–∏—Å–∫ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ "—Å–∏–º–≤–æ–ª:—á–∏—Å–ª–æ" —Å –ø–æ–º–æ—â—å—é —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π
3. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤ –±–µ–∑ –≤–µ—Å–æ–≤
4. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤–µ—Å–æ–≤

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ –∫–∞–∫ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏. –°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞ (–∑–∞–ø—è—Ç—ã–µ –∏ –ø—Ä–æ–±–µ–ª—ã) –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å.

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–æ–±–µ–ª–æ–≤ –∫–∞–∫ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π
- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –∑–∞–ø—è—Ç—ã–º–∏
- ‚úÖ –°–º–µ—à–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã
- ‚úÖ –†—É—Å—Å–∫–∞—è –ª–æ–∫–∞–ª—å (–∑–∞–ø—è—Ç—ã–µ –≤ —á–∏—Å–ª–∞—Ö)
- ‚úÖ –í—Å–µ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –î–∞—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:
14 —Å–µ–Ω—Ç—è–±—Ä—è 2025
