# –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –æ—à–∏–±–∫–∏ Button_data_invalid –≤ –∫–æ–º–∞–Ω–¥–µ /compare

## üéØ –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ –±–æ–ª–µ–µ 4 –∞–∫—Ç–∏–≤–æ–≤ –≤ –∫–æ–º–∞–Ω–¥—É `/compare` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `SBER.MOEX LKOH.MOEX LQDT.MOEX OBLG.MOEX GOLD.MOEX`) –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞:
```
2025-09-13 22:33:21,238 - ERROR - Error sending photo: Button_data_invalid
WARNING - Failed to send with parse_mode 'HTML': Button_data_invalid
WARNING - Failed to send with reply_markup: Button_data_invalid
```

## üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–∏—á–∏–Ω—ã
–û—à–∏–±–∫–∞ –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –∏–∑-–∑–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞ Telegram API –Ω–∞ —Ä–∞–∑–º–µ—Ä `callback_data` –∫–Ω–æ–ø–æ–∫, –∫–æ—Ç–æ—Ä—ã–π —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç **64 –±–∞–π—Ç–∞**.

### –ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:
```python
# –°—Ç–∞—Ä—ã–π –ø–æ–¥—Ö–æ–¥ - –ø–µ—Ä–µ–¥–∞—á–∞ –≤—Å–µ—Ö —Å–∏–º–≤–æ–ª–æ–≤ –≤ callback_data
symbols_str = '_'.join(symbols)
callback_data = f"compare_portfolio_{symbols_str}"
```

### –†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞:
- **–°–∏–º–≤–æ–ª—ã**: `SBER.MOEX_LKOH.MOEX_LQDT.MOEX_OBLG.MOEX_GOLD.MOEX`
- **Callback data**: `compare_portfolio_SBER.MOEX_LKOH.MOEX_LQDT.MOEX_OBLG.MOEX_GOLD.MOEX`
- **–†–∞–∑–º–µ—Ä**: **67 –±–∞–π—Ç** (–ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç –≤ 64 –±–∞–π—Ç–∞)

## ‚úÖ –†–µ—à–µ–Ω–∏–µ
–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –Ω–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö –≤ `callback_data`.

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ:

#### 1. –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `_create_compare_command_keyboard`
**–§–∞–π–ª**: `bot.py`, —Å—Ç—Ä–æ–∫–∏ 8264-8293

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
- –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `update` –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ `user_id`
- –°–∏–º–≤–æ–ª—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: `user_context['compare_portfolio_symbols'] = symbols`
- Callback data —É–ø—Ä–æ—â–µ–Ω –¥–æ: `"compare_portfolio"`

```python
def _create_compare_command_keyboard(self, symbols: list, currency: str, update: Update = None, specified_period: str = None) -> InlineKeyboardMarkup:
    # ...
    # Add Portfolio button - store symbols in context to avoid callback_data size limit
    if update:
        user_id = update.effective_user.id
        user_context = self._get_user_context(user_id)
        user_context['compare_portfolio_symbols'] = symbols
    
    keyboard.append([
        InlineKeyboardButton("üíº –í –ü–æ—Ä—Ç—Ñ–µ–ª—å", callback_data="compare_portfolio")
    ])
```

#### 2. –û–±–Ω–æ–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ callback'–æ–≤
**–§–∞–π–ª**: `bot.py`, —Å—Ç—Ä–æ–∫–∏ 5957-5963

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
- –£–±—Ä–∞–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–∏–º–≤–æ–ª–æ–≤ –∏–∑ `callback_data`
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–∏–º–≤–æ–ª–æ–≤ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```python
elif callback_data == 'compare_portfolio':
    # Get symbols from user context instead of callback_data to avoid size limit
    user_id = update.effective_user.id
    user_context = self._get_user_context(user_id)
    symbols = user_context.get('compare_portfolio_symbols', [])
    await self._handle_compare_portfolio_button(update, context, symbols)
```

#### 3. –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ –≤—ã–∑–æ–≤—ã —Ñ—É–Ω–∫—Ü–∏–∏
–í—Å–µ –≤—ã–∑–æ–≤—ã `_create_compare_command_keyboard` –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `update`.

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –†–∞–∑–º–µ—Ä callback_data:
- **–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: 67 –±–∞–π—Ç (–ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç)
- **–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: 17 –±–∞–π—Ç (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ª–∏–º–∏—Ç–∞)
- **–≠–∫–æ–Ω–æ–º–∏—è**: 50 –±–∞–π—Ç

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
–°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç `test_compare_button_data_fix.py` –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç:
- –°—Ç–∞—Ä—ã–π –ø–æ–¥—Ö–æ–¥ –ø—Ä–µ–≤—ã—à–∞–ª –ª–∏–º–∏—Ç –≤ 64 –±–∞–π—Ç–∞
- –ù–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ª–∏–º–∏—Ç–∞
- –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞

## üöÄ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ—à–µ–Ω–∏—è

1. **–°–æ–±–ª—é–¥–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ Telegram API** - callback_data —Ç–µ–ø–µ—Ä—å –≤—Å–µ–≥–¥–∞ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 64 –±–∞–π—Ç
2. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - —Ä–µ—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ª—é–±—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∞–∫—Ç–∏–≤–æ–≤
3. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏** - –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∫–æ–º–∞–Ω–¥—ã `/compare` –æ—Å—Ç–∞–ª–∏—Å—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
4. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—Ç–æ –±–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è:
1. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö**: –°–∏–º–≤–æ–ª—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `user_context['compare_portfolio_symbols']` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
2. **–ü–µ—Ä–µ–¥–∞—á–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞**: –í `callback_data` –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ—Ä–æ—Ç–∫–∏–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä `"compare_portfolio"`
3. **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö**: –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ callback'–∞ —Å–∏–º–≤–æ–ª—ã –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:
- –†–µ—à–µ–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ
- –ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –¥—Ä—É–≥–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–æ—Ç–∞
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

## ‚úÖ –°—Ç–∞—Ç—É—Å
- [x] –ü—Ä–æ–±–ª–µ–º–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞
- [x] –†–µ—à–µ–Ω–∏–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
- [x] –ö–æ–¥ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞
- [x] –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ
–û—à–∏–±–∫–∞ `Button_data_invalid` –≤ –∫–æ–º–∞–Ω–¥–µ `/compare` –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ –±–æ–ª–µ–µ 4 –∞–∫—Ç–∏–≤–æ–≤ —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞. –†–µ—à–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ–¥–∞—á–∏ –∏—Ö –≤ `callback_data`, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –ª—é–±—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∞–∫—Ç–∏–≤–æ–≤ –±–µ–∑ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤ Telegram API.
