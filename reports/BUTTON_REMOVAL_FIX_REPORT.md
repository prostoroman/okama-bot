# Отчет об исправлении удаления кнопок в команде /info

## Задача

Исправить проблему с кнопками команды `/info`, которые не исчезали со старых сообщений при отправке новых сообщений.

## Проблема

При нажатии на любые кнопки в команде `/info` (переключение периодов, анализ рисков, метрики, AI-анализ, сравнение, портфель, дивиденды) создавались новые сообщения с результатами, но кнопки оставались на старых сообщениях, что создавало путаницу для пользователей.

## Решение

### Изменения в коде

**Файл**: `bot.py`  
**Функции**: 
- `_handle_okama_info_period_button()` (строки 7355-7389)
- `_handle_tushare_info_period_button()` (строки 7391-7434)
- `_handle_info_risks_button()` (строки 7436-7492)
- `_handle_info_metrics_button()` (строки 7494-7561)
- `_handle_info_ai_analysis_button()` (строки 7563-7601)
- `_handle_info_compare_button()` (строки 7603-7634)
- `_handle_info_portfolio_button()` (строки 7636-7665)
- `_handle_single_dividends_button()` (строки 7738-7790)

#### Добавлен код для удаления кнопок со старого сообщения во всех функциях:

```python
# Remove buttons from the old message
try:
    await update.callback_query.edit_message_reply_markup(reply_markup=None)
except Exception as e:
    self.logger.warning(f"Could not remove buttons from old message: {e}")
```

### Детальные изменения

#### 1. Функция `_handle_okama_info_period_button()`

**Добавлено в начало функции:**
- Удаление кнопок со старого сообщения перед получением данных за новый период
- Обработка ошибок при удалении кнопок

**Логика работы:**
1. Удаляются кнопки со старого сообщения
2. Получаются данные актива за новый период
3. Отправляется новое сообщение с графиком и кнопками

#### 2. Функция `_handle_tushare_info_period_button()`

**Добавлено в начало функции:**
- Удаление кнопок со старого сообщения перед получением данных Tushare
- Обработка ошибок при удалении кнопок

**Логика работы:**
1. Удаляются кнопки со старого сообщения
2. Проверяется доступность сервиса Tushare
3. Получаются данные актива за новый период
4. Отправляется новое сообщение с графиком и кнопками

#### 3. Функция `_handle_info_risks_button()`

**Добавлено в начало функции:**
- Удаление кнопок со старого сообщения перед анализом рисков
- Обработка ошибок при удалении кнопок

**Логика работы:**
1. Удаляются кнопки со старого сообщения
2. Показывается временное сообщение о загрузке
3. Выполняется анализ рисков
4. Отправляется новое сообщение с результатами

#### 4. Функция `_handle_info_metrics_button()`

**Добавлено в начало функции:**
- Удаление кнопок со старого сообщения перед получением метрик
- Обработка ошибок при удалении кнопок

**Логика работы:**
1. Удаляются кнопки со старого сообщения
2. Показывается временное сообщение о загрузке
3. Получаются все метрики актива
4. Отправляется новое сообщение с результатами

#### 5. Функция `_handle_info_ai_analysis_button()`

**Добавлено в начало функции:**
- Удаление кнопок со старого сообщения перед AI-анализом
- Обработка ошибок при удалении кнопок

**Логика работы:**
1. Удаляются кнопки со старого сообщения
2. Показывается временное сообщение о загрузке
3. Выполняется AI-анализ
4. Отправляется новое сообщение с результатами

#### 6. Функция `_handle_info_compare_button()`

**Добавлено в начало функции:**
- Удаление кнопок со старого сообщения перед подготовкой сравнения
- Обработка ошибок при удалении кнопок

**Логика работы:**
1. Удаляются кнопки со старого сообщения
2. Устанавливается контекст ожидания ввода для сравнения
3. Отправляется новое сообщение с инструкциями

#### 7. Функция `_handle_info_portfolio_button()`

**Добавлено в начало функции:**
- Удаление кнопок со старого сообщения перед подготовкой портфеля
- Обработка ошибок при удалении кнопок

**Логика работы:**
1. Удаляются кнопки со старого сообщения
2. Устанавливается контекст ожидания ввода для портфеля
3. Отправляется новое сообщение с инструкциями

#### 8. Функция `_handle_single_dividends_button()`

**Добавлено в начало функции:**
- Удаление кнопок со старого сообщения перед получением информации о дивидендах
- Обработка ошибок при удалении кнопок

**Логика работы:**
1. Удаляются кнопки со старого сообщения
2. Показывается временное сообщение о загрузке
3. Получается информация о дивидендах
4. Отправляется новое сообщение с результатами

## Результат

Теперь при нажатии на любую кнопку в команде `/info`:
- Кнопки автоматически удаляются со старого сообщения
- Отправляется новое сообщение с результатами
- Пользователь видит только актуальные кнопки на новом сообщении

## Технические детали

- Используется метод `update.callback_query.edit_message_reply_markup(reply_markup=None)` для удаления кнопок
- Добавлена обработка ошибок с логированием предупреждений
- Код добавлен в начало каждой функции обработки кнопок
- Изменения не влияют на основную логику функций

## Дата исправления

$(date '+%Y-%m-%d %H:%M:%S')
