# Отчет об исправлении обработки кнопок портфеля и сравнения

## Проблема
При нажатии на переименованные кнопки портфеля и сравнения возникали ошибки:

```
⚖️ Сравниваю ▫️, Доходность, ГГ...
❌ Ошибка при создании сравнения: ▫️ is not in allowed assets namespaces

⚖️ Сравниваю ▫️, Нейроанализ...
❌ Ошибка при создании сравнения: ▫️ is not in allowed assets namespaces
```

## Причина ошибки
Функции определения кнопок reply keyboard (`_is_portfolio_reply_keyboard_button` и `_is_compare_reply_keyboard_button`) содержали старые названия кнопок. Из-за этого кнопки не распознавались как reply keyboard кнопки и обрабатывались как обычный текст, который попадал в логику сравнения.

## Исправления

### 1. Функция `_is_portfolio_reply_keyboard_button` (строки 9928-9943)

**Было:**
```python
portfolio_buttons = [
    "▫️ Накоп. доходность",
    "▫️ Годовая доходность",      # ← Старое название
    "▫️ Скользящая CAGR",         # ← Старое название
    "▫️ Дивиденды",
    "▫️ Метрики",
    "▫️ Монте-Карло",
    "▫️ Процентили (10/50/90)",
    "▫️ Просадки",
    "▫️ AI-анализ",               # ← Старое название
    "▫️ Портфель vs Активы",
    "▫️ Сравнить"
]
```

**Стало:**
```python
portfolio_buttons = [
    "▫️ Накоп. доходность",
    "▫️ Доходность ГГ",           # ← Новое название
    "▫️ Динамика дох.",           # ← Новое название
    "▫️ Дивиденды",
    "▫️ Метрики",
    "▫️ Монте-Карло",
    "▫️ Процентили (10/50/90)",
    "▫️ Просадки",
    "▫️ Нейроанализ",             # ← Новое название
    "▫️ Портфель vs Активы",
    "▫️ Сравнить"
]
```

### 2. Функция `_is_compare_reply_keyboard_button` (строки 9945-9957)

**Было:**
```python
compare_buttons = [
    "▫️ Доходность",
    "▫️ Дивиденды",
    "▫️ Просадки",
    "▫️ Метрики",
    "▫️ Корреляция",
    "▫️ Эффективная граница",
    "▫️ AI-анализ",              # ← Старое название
    "▫️ В Портфель"
]
```

**Стало:**
```python
compare_buttons = [
    "▫️ Доходность",
    "▫️ Дивиденды",
    "▫️ Просадки",
    "▫️ Метрики",
    "▫️ Корреляция",
    "▫️ Эффективная граница",
    "▫️ Нейроанализ",            # ← Новое название
    "▫️ В Портфель"
]
```

## Логика обработки

### 1. Проверка кнопки
Функция `_is_reply_keyboard_button` вызывает соответствующие функции проверки для определения типа кнопки.

### 2. Обработка кнопки
Если кнопка распознана, вызывается `_handle_reply_keyboard_button`, который определяет контекст и вызывает соответствующий обработчик:
- `_handle_portfolio_reply_keyboard_button` для кнопок портфеля
- `_handle_compare_reply_keyboard_button` для кнопок сравнения

### 3. Альтернативная обработка
Если кнопка не распознана как reply keyboard кнопка, текст обрабатывается как обычное сообщение и может попасть в логику сравнения, что вызывало ошибки.

## Результат

✅ **Проблема решена полностью**
- Кнопки портфеля теперь корректно распознаются
- Кнопки сравнения теперь корректно распознаются
- Ошибки "is not in allowed assets namespaces" больше не возникают
- Все переименованные кнопки работают корректно

## Протестированные кнопки

### Портфель:
- ✅ "▫️ Доходность ГГ" - работает корректно
- ✅ "▫️ Динамика дох." - работает корректно
- ✅ "▫️ Нейроанализ" - работает корректно

### Сравнение:
- ✅ "▫️ Нейроанализ" - работает корректно

## Дата исправления
$(date)
