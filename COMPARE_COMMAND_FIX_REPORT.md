# –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã /compare

## üö® –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É `/compare OBLG.MOEX LQDT.MOEX GOLD.MOEX` –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞:

```
‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è: Unknown error in HTTP implementation: TypeError('Object of type set is not JSON serializable')
```

## üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã

–ë—ã–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –¥–≤–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –≤ –∫–æ–¥–µ:

### 1. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å–∏–≥–Ω–∞—Ç—É—Ä–∞ –º–µ—Ç–æ–¥–∞ `_update_user_context`
```python
# –ë—ã–ª–æ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
def _update_user_context(self, user_id: int, kwargs):

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
def _update_user_context(self, user_id: int, **kwargs):
```

**–ü—Ä–æ–±–ª–µ–º–∞**: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ `**` –ø–µ—Ä–µ–¥ `kwargs` –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ —Ç–æ–º—É, —á—Ç–æ –º–µ—Ç–æ–¥ –æ–∂–∏–¥–∞–ª –æ–¥–∏–Ω –∞—Ä–≥—É–º–µ–Ω—Ç —Ç–∏–ø–∞ `dict`, –∞ –ø–æ–ª—É—á–∞–ª –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã.

### 2. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç caption –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ
```python
# –ë—ã–ª–æ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
caption={stats_text}

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
caption=stats_text
```

**–ü—Ä–æ–±–ª–µ–º–∞**: –§–∏–≥—É—Ä–Ω—ã–µ —Å–∫–æ–±–∫–∏ `{}` –≤–æ–∫—Ä—É–≥ `stats_text` —Å–æ–∑–¥–∞–≤–∞–ª–∏ `set` –æ–±—ä–µ–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω –≤ JSON –¥–ª—è Telegram API.

## üîß –ü—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1: –°–∏–≥–Ω–∞—Ç—É—Ä–∞ –º–µ—Ç–æ–¥–∞
```python
def _update_user_context(self, user_id: int, **kwargs):
    """–û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    context = self._get_user_context(user_id)
    context.update(kwargs)
    
    # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
    if 'conversation_history' in context and len(context['conversation_history']) > 10:
        context['conversation_history'] = context['conversation_history'][-10:]
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
- –î–æ–±–∞–≤–ª–µ–Ω `**` –ø–µ—Ä–µ–¥ `kwargs` –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–µ–º–∞ –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã—Ö –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
- –¢–µ–ø–µ—Ä—å –º–µ—Ç–æ–¥ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≤—ã–∑–æ–≤—ã —Ç–∏–ø–∞:
  ```python
  self._update_user_context(
      user_id, 
      last_assets=symbols,
      last_analysis_type='comparison',
      last_period='MAX'
  )
  ```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2: –§–æ—Ä–º–∞—Ç caption
```python
# Send chart image
await context.bot.send_photo(
    chat_id=update.effective_chat.id, 
    photo=io.BytesIO(img_bytes),
    caption=stats_text  # –£–±—Ä–∞–Ω—ã —Ñ–∏–≥—É—Ä–Ω—ã–µ —Å–∫–æ–±–∫–∏
)
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
- –£–±—Ä–∞–Ω—ã —Ñ–∏–≥—É—Ä–Ω—ã–µ —Å–∫–æ–±–∫–∏ `{}` –≤–æ–∫—Ä—É–≥ `stats_text`
- –¢–µ–ø–µ—Ä—å `caption` –ø–æ–ª—É—á–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –Ω–∞–ø—Ä—è–º—É—é, –∞ –Ω–µ `set` –æ–±—ä–µ–∫—Ç

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- ‚úÖ –°–∏–≥–Ω–∞—Ç—É—Ä–∞ –º–µ—Ç–æ–¥–∞ `_update_user_context`
- ‚úÖ –§–æ—Ä–º–∞—Ç caption –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ MOEX —Å–∏–º–≤–æ–ª–æ–≤
- ‚úÖ –õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤–∞–ª—é—Ç—ã

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤
- **–ú–µ—Ç–æ–¥ signature**: ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å `**kwargs`
- **Caption format**: ‚úÖ –°—Ç—Ä–æ–∫–∞ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –±–µ–∑ —Ñ–∏–≥—É—Ä–Ω—ã—Ö —Å–∫–æ–±–æ–∫
- **MOEX symbols**: ‚úÖ –í—Å–µ —Å–∏–º–≤–æ–ª—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞—Å–ø–æ–∑–Ω–∞—é—Ç—Å—è
- **Currency detection**: ‚úÖ RUB –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–ª—è MOEX

## üìä –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –í—ã–∑–æ–≤—ã –º–µ—Ç–æ–¥–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
```python
# –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤—ã–∑–æ–≤:
self._update_user_context(
    user_id, 
    last_assets=symbols,
    last_analysis_type='comparison',
    last_period='MAX'
)

# –ú–µ—Ç–æ–¥ —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã
def _update_user_context(self, user_id: int, **kwargs):
    context = self._get_user_context(user_id)
    context.update(kwargs)  # kwargs —Ç–µ–ø–µ—Ä—å dict —Å –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–º–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏
```

### –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
```python
# –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞:
await context.bot.send_photo(
    chat_id=update.effective_chat.id, 
    photo=io.BytesIO(img_bytes),
    caption=stats_text  # stats_text –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞
)
```

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –∫–æ–º–∞–Ω–¥–∞ `/compare OBLG.MOEX LQDT.MOEX GOLD.MOEX` –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:

1. **–°–∏–º–≤–æ–ª—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è** - –≤—Å–µ MOEX —Å–∏–º–≤–æ–ª—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞—Å–ø–æ–∑–Ω–∞—é—Ç—Å—è
2. **–í–∞–ª—é—Ç–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è RUB –¥–ª—è MOEX –∞–∫—Ç–∏–≤–æ–≤
3. **–ö–æ–Ω—Ç–µ–∫—Å—Ç –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è** - –º–µ—Ç–æ–¥ `_update_user_context` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
4. **–§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è** - caption –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
5. **–ì—Ä–∞—Ñ–∏–∫ —Å–æ–∑–¥–∞–µ—Ç—Å—è** - –∫—Ä–∞—Å–∏–≤—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ —Å –ø–æ–ª–Ω—ã–º –ø–µ—Ä–∏–æ–¥–æ–º –¥–∞–Ω–Ω—ã—Ö

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–¢–µ–ø–µ—Ä—å –∫–æ–º–∞–Ω–¥–∞ `/compare` –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –∞–∫—Ç–∏–≤–æ–≤:
- ‚úÖ **MOEX –∞–∫—Ç–∏–≤—ã** (RUB –≤–∞–ª—é—Ç–∞)
- ‚úÖ **US –∞–∫—Ç–∏–≤—ã** (USD –≤–∞–ª—é—Ç–∞)  
- ‚úÖ **LSE –∞–∫—Ç–∏–≤—ã** (GBP –≤–∞–ª—é—Ç–∞)
- ‚úÖ **–¢–æ–≤–∞—Ä—ã –∏ –≤–∞–ª—é—Ç—ã** (USD –≤–∞–ª—é—Ç–∞)

## üìä –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∞–Ω–∞–ª–∏–∑–∞

### Drawdowns History
–ö–æ–º–∞–Ω–¥–∞ `/compare` –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∏—Å—Ç–æ—Ä–∏–∏ drawdowns –¥–ª—è –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–æ–≤ –≤ —Å–ø–∏—Å–∫–µ:
```python
# –ò—Å—Ç–æ—Ä–∏—è drawdowns –ª–µ–≥–∫–æ –¥–æ—Å—Ç—É–ø–Ω–∞ –∏ –≤–∏–¥–Ω–∞
x.drawdowns.plot()
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- **–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∏—Å–∫–æ–≤** - –≥—Ä–∞—Ñ–∏–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–µ—Ä–∏–æ–¥—ã –ø–∞–¥–µ–Ω–∏—è –∞–∫—Ç–∏–≤–æ–≤
- **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏** - –º–æ–∂–Ω–æ –æ—Ü–µ–Ω–∏—Ç—å, –∫–∞–∫–∏–µ –∞–∫—Ç–∏–≤—ã –±–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω—ã
- **–ê–Ω–∞–ª–∏–∑ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è** - –≤–∏–¥–Ω–æ, –∫–∞–∫ –±—ã—Å—Ç—Ä–æ –∞–∫—Ç–∏–≤—ã –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –ø–∞–¥–µ–Ω–∏–π

### Dividend Yield History
–î–æ—Å—Ç—É–ø–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è –¥–∏–≤–∏–¥–µ–Ω–¥–Ω–æ–π –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ –¥–ª—è –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–æ–≤:
```python
# –ò—Å—Ç–æ—Ä–∏—è –¥–∏–≤–∏–¥–µ–Ω–¥–Ω–æ–π –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏
x.dividend_yield.tail()
```

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∞–Ω–∞–ª–∏–∑–∞:**
- **–î–∏–≤–∏–¥–µ–Ω–¥–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è** - —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ –ø–æ –¥–∏–≤–∏–¥–µ–Ω–¥–∞–º
- **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –≤—ã–ø–ª–∞—Ç** - –∞–Ω–∞–ª–∏–∑ —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç–∏ –¥–∏–≤–∏–¥–µ–Ω–¥–Ω—ã—Ö –≤—ã–ø–ª–∞—Ç
- **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–ª–∞—Å—Å–æ–≤ –∞–∫—Ç–∏–≤–æ–≤** - –∞–∫—Ü–∏–∏ vs –æ–±–ª–∏–≥–∞—Ü–∏–∏ vs —Ç–æ–≤–∞—Ä—ã

## üéØ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç –Ω–µ —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–π –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏, –Ω–æ –∏:
- ‚úÖ **–ì—Ä–∞—Ñ–∏–∫–∏ drawdowns** –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ä–∏—Å–∫–æ–≤
- ‚úÖ **–ò—Å—Ç–æ—Ä–∏—é –¥–∏–≤–∏–¥–µ–Ω–¥–æ–≤** –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏
- ‚úÖ **–ü–æ–ª–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –¥–∞–Ω–Ω—ã—Ö** –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
- ‚úÖ **–ö—Ä–∞—Å–∏–≤—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏** —Å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º –¥–∏–∑–∞–π–Ω–æ–º
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–∞–ª—é—Ç—ã** –ø–æ –ø–µ—Ä–≤–æ–º—É –∞–∫—Ç–∏–≤—É

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∞–∫—Ç–∏–≤–æ–≤ —Å –∫—Ä–∞—Å–∏–≤—ã–º–∏ –≥—Ä–∞—Ñ–∏–∫–∞–º–∏, –ø–æ–ª–Ω—ã–º –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º –∞–Ω–∞–ª–∏–∑–æ–º –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏ —Ä–∏—Å–∫–∞ –∏ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏!
