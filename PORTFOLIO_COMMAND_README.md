# Команда /portfolio для Okama Finance Bot

## Описание

Новая команда `/portfolio` позволяет создавать портфели с указанными активами и их долями, используя библиотеку Okama для анализа и визуализации.

## Синтаксис

```
/portfolio символ1:доля1 символ2:доля2 символ3:доля3 ...
```

## Параметры

- **символ** - тикер актива (например, SPY.US, SBER.MOEX, GC.COMM)
- **доля** - вес актива в портфеле от 0 до 1 (например, 0.5 = 50%)

## Примеры использования

### Американский портфель
```
/portfolio SPY.US:0.5 QQQ.US:0.3 BND.US:0.2
```
- 50% S&P 500 ETF (SPY.US)
- 30% NASDAQ ETF (QQQ.US)  
- 20% Total Bond Market ETF (BND.US)

### Российский портфель
```
/portfolio SBER.MOEX:0.4 GAZP.MOEX:0.3 LKOH.MOEX:0.3
```
- 40% Сбербанк (SBER.MOEX)
- 30% Газпром (GAZP.MOEX)
- 30% Лукойл (LKOH.MOEX)

### Диверсифицированный портфель
```
/portfolio VOO.US:0.6 GC.COMM:0.2 BND.US:0.2
```
- 60% Vanguard S&P 500 ETF (VOO.US)
- 20% Золото (GC.COMM)
- 20% Total Bond Market ETF (BND.US)

## Важные моменты

1. **Сумма долей должна быть равна 1.0 (100%)**
2. **Базовая валюта определяется автоматически по первому символу:**
   - MOEX активы → RUB
   - US активы → USD
   - LSE активы → GBP
   - Остальные → USD по умолчанию
3. **Максимум 10 активов в портфеле**
4. **Поддерживаются все типы активов:**
   - Акции (US, MOEX, LSE)
   - Облигации
   - Товары (золото, нефть, серебро)
   - Индексы
   - Валютные пары

## Что вы получаете

✅ **График накопленной доходности портфеля** - красивый график с использованием стиля fivethirtyeight
✅ **Таблица активов с весами** - детальная информация о составе портфеля
✅ **Основные характеристики** - период данных, длительность, базовая валюта
✅ **Автоматическое определение валюты** - по первому активу в списке

## Техническая реализация

### Парсинг аргументов
Команда поддерживает различные форматы ввода:
- Пробелы между активами: `SPY.US:0.5 QQQ.US:0.3 BND.US:0.2`
- Смешанный формат: `SPY.US:0.5, QQQ.US:0.3, BND.US:0.2`

### Валидация
- Проверка корректности долей (0 < доля ≤ 1)
- Проверка суммы долей (должна быть ≈ 1.0)
- Проверка количества активов (максимум 10)

### Создание портфеля
```python
import okama as ok
portfolio = ok.Portfolio(symbols, ccy=currency, weights=weights)
```

### Визуализация
- Использование matplotlib с стилем fivethirtyeight
- Оптимизация памяти (очистка кэша после создания графика)
- Красивое оформление с подписями и легендой

## Обработка ошибок

Команда включает детальную обработку ошибок:
- Некорректный формат аргументов
- Некорректные доли
- Недоступные символы
- Проблемы с данными
- Ошибки создания портфеля

## Интеграция с ботом

Команда интегрирована в основной функционал бота:
- Добавлена в справку `/start`
- Регистрируется как обработчик команд
- Сохраняет данные портфеля в контексте пользователя
- Использует существующую инфраструктуру для отправки сообщений и изображений

## Тестирование

Создан тестовый скрипт `test_portfolio.py` для проверки:
- Парсинга аргументов
- Валидации долей
- Определения валюты
- Создания портфеля через Okama

## Совместимость

- Python 3.7+
- Okama библиотека 1.5.0+
- python-telegram-bot
- matplotlib
- pandas

## Планы развития

В будущем планируется добавить:
- Анализ риска портфеля (VaR, Sharpe ratio)
- Сравнение с бенчмарками
- Рекомендации по ребалансировке
- Экспорт данных портфеля
- Интеграция с AI-анализом
