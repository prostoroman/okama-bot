# –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –æ—à–∏–±–∫–∏ Button_data_invalid

## –î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
2025-08-31

## –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
–ü—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã `/portfolio sber.moex:0.3 gazp.moex:0.6 gold.moex:0.05 lqdt.moex:0.05` –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞:

```
‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ—Ä—Ç—Ñ–µ–ª—è: Button_data_invalid...
```

## üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–∏—á–∏–Ω—ã

### –ü—Ä–æ–±–ª–µ–º–∞
–û—à–∏–±–∫–∞ `Button_data_invalid` –≤–æ–∑–Ω–∏–∫–∞–µ—Ç, –∫–æ–≥–¥–∞ callback_data –∫–Ω–æ–ø–æ–∫ Telegram –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç –≤ **64 –±–∞–π—Ç–∞**.

### –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ (–ø—Ä–æ–±–ª–µ–º–Ω—ã–π)
```python
# Create portfolio data string with weights for callback
portfolio_data_str = ','.join([f"{symbol}:{weight:.3f}" for symbol, weight in zip(symbols, weights)])

# –ü—Ä–∏–º–µ—Ä –¥–ª—è 4 –∞–∫—Ç–∏–≤–æ–≤:
# risk_metrics_SBER.MOEX:0.300,GAZP.MOEX:0.600,GOLD.MOEX:0.050,LQDT.MOEX:0.050
# –î–ª–∏–Ω–∞: 67 —Å–∏–º–≤–æ–ª–æ–≤ > 64 –±–∞–π—Ç–∞ ‚ùå
```

### –†–∞—Å—á–µ—Ç –¥–ª–∏–Ω—ã
- `risk_metrics_` = 15 —Å–∏–º–≤–æ–ª–æ–≤
- `SBER.MOEX:0.300` = 16 —Å–∏–º–≤–æ–ª–æ–≤  
- `,` = 1 —Å–∏–º–≤–æ–ª
- `GAZP.MOEX:0.600` = 16 —Å–∏–º–≤–æ–ª–æ–≤
- `,` = 1 —Å–∏–º–≤–æ–ª
- `GOLD.MOEX:0.050` = 15 —Å–∏–º–≤–æ–ª–æ–≤
- `,` = 1 —Å–∏–º–≤–æ–ª
- `LQDT.MOEX:0.050` = 15 —Å–∏–º–≤–æ–ª–æ–≤
- **–ò—Ç–æ–≥–æ: 67 —Å–∏–º–≤–æ–ª–æ–≤** ‚ùå

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –£–ø—Ä–æ—â–µ–Ω–∏–µ callback_data
**–ë—ã–ª–æ**: –ü–µ—Ä–µ–¥–∞—á–∞ —Å–∏–º–≤–æ–ª–æ–≤ + –≤–µ—Å–æ–≤ –≤ callback_data
```python
portfolio_data_str = ','.join([f"{symbol}:{weight:.3f}" for symbol, weight in zip(symbols, weights)])
```

**–°—Ç–∞–ª–æ**: –ü–µ—Ä–µ–¥–∞—á–∞ —Ç–æ–ª—å–∫–æ —Å–∏–º–≤–æ–ª–æ–≤
```python
portfolio_data_str = ','.join(symbols)
```

### 2. –ü–µ—Ä–µ–¥–∞—á–∞ –≤–µ—Å–æ–≤ —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç
–í–µ—Å–∞ —Ç–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∞ –Ω–µ —á–µ—Ä–µ–∑ callback_data:

```python
# –í–µ—Å–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ—Ä—Ç—Ñ–µ–ª—è
self._update_user_context(
    user_id, 
    portfolio_weights=weights,  # –í–µ—Å–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∑–¥–µ—Å—å
    # ... –¥—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
)

# –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ –≤–µ—Å–∞ –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
raw_weights = user_context.get('portfolio_weights', [])
weights = self._normalize_or_equalize_weights(final_symbols, raw_weights)
```

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
–í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —É–ø—Ä–æ—â–µ–Ω–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º:

```python
elif callback_data.startswith('risk_metrics_'):
    symbols = callback_data.replace('risk_metrics_', '').split(',')
    self.logger.info(f"Risk metrics button clicked for symbols: {symbols}")
    await self._handle_risk_metrics_button(update, context, symbols)
```

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–æ–≤

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
```
callback_data: "risk_metrics_SBER.MOEX:0.300,GAZP.MOEX:0.600,GOLD.MOEX:0.050,LQDT.MOEX:0.050"
–î–ª–∏–Ω–∞: 67 —Å–∏–º–≤–æ–ª–æ–≤ ‚ùå
–°—Ç–∞—Ç—É—Å: Button_data_invalid
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
```
callback_data: "risk_metrics_SBER.MOEX,GAZP.MOEX,GOLD.MOEX,LQDT.MOEX"
–î–ª–∏–Ω–∞: 47 —Å–∏–º–≤–æ–ª–æ–≤ ‚úÖ
–°—Ç–∞—Ç—É—Å: –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
```

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è
1. **–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª—è**: –í–µ—Å–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. **Callback –∫–Ω–æ–ø–æ–∫**: –ü–µ—Ä–µ–¥–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å–∏–º–≤–æ–ª—ã (–∫–æ–º–ø–∞–∫—Ç–Ω–æ)
3. **–û–±—Ä–∞–±–æ—Ç–∫–∞**: –í–µ—Å–∞ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
4. **–°–æ–∑–¥–∞–Ω–∏–µ Portfolio**: –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –≤–µ—Å–∞

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞
- ‚úÖ **–ö–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç—å**: callback_data –≤—Å–µ–≥–¥–∞ < 64 –±–∞–π—Ç
- ‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –í–µ—Å–∞ –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ
- ‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –†–∞–±–æ—Ç–∞–µ—Ç —Å –ª—é–±—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∞–∫—Ç–∏–≤–æ–≤
- ‚úÖ **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**: –ï–¥–∏–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –¥–ª—è –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫

### –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- ‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∫ –ø—Ä–µ–∂–¥–µ
- ‚úÖ –õ–æ–≥–∏–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—è –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–∞

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
```
/portfolio sber.moex:0.3 gazp.moex:0.6 gold.moex:0.05 lqdt.moex:0.05
```

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- ‚úÖ –ü–æ—Ä—Ç—Ñ–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
- ‚úÖ –ì—Ä–∞—Ñ–∏–∫ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
- ‚úÖ –ö–Ω–æ–ø–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ –í–µ—Å–∞ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ callback_data
```python
# –î–ª–∏–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å < 64 —Å–∏–º–≤–æ–ª–æ–≤
risk_metrics_SBER.MOEX,GAZP.MOEX,GOLD.MOEX,LQDT.MOEX
# –î–ª–∏–Ω–∞: 47 —Å–∏–º–≤–æ–ª–æ–≤ ‚úÖ
```

## üöÄ –°—Ç–∞—Ç—É—Å

**–û–®–ò–ë–ö–ê BUTTON_DATA_INVALID –ò–°–ü–†–ê–í–õ–ï–ù–ê** ‚úÖ

- ‚úÖ callback_data —Å–æ–∫—Ä–∞—â–µ–Ω–∞ –¥–æ < 64 –±–∞–π—Ç
- ‚úÖ –í–µ—Å–∞ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ –í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- ‚úÖ –§–∞–π–ª –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞

**–ö–æ–º–∞–Ω–¥–∞ `/portfolio` —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å –ª—é–±—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∞–∫—Ç–∏–≤–æ–≤!** üéâ

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ö–æ–º–∞–Ω–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –ø—Ä–µ–∂–¥–µ
- –í–µ—Å–∞ —É–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤ —Ç–æ–º –∂–µ —Ñ–æ—Ä–º–∞—Ç–µ
- –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∞–Ω–∞–ª–∏–∑–∞ –¥–æ—Å—Ç—É–ø–Ω—ã

### –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
- callback_data —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ —Å–∏–º–≤–æ–ª—ã
- –í–µ—Å–∞ –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `user_context.get('portfolio_weights', [])` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤–µ—Å–æ–≤
