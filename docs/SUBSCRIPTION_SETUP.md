# Настройка платной подписки

## Обзор

Бот теперь поддерживает платную подписку Pro с безлимитным доступом к функциям. Бесплатные пользователи ограничены 30 запросами в день (настраивается).

## Компоненты

### 1. База данных (`services/db.py`)
- SQLite база данных для хранения пользователей и подписок
- Таблица `users` с полями: `user_id`, `plan`, `requests_today`, `last_request`, `paid_until`
- Функции: `init_db()`, `ensure_user()`, `can_use()`, `upgrade_to_pro()`

### 2. Сервис платежей (`services/payment_service.py`)
- Обработка платежей через Telegram Stars
- Создание инвойсов и обработка успешных платежей
- Команды `/buy` и `/profile`

### 3. Обновленный rate limiter (`services/rate_limiter.py`)
- Проверка Pro статуса перед применением лимитов
- Paywall для пользователей с исчерпанным лимитом
- Автоматическое обновление счетчика запросов

## Настройка

### Переменные окружения

Добавьте в `config.env`:

```bash
# Subscription and Payment Configuration
SUBSCRIPTION_DB_PATH=/var/data/bot.db
PRO_PRICE_STARS=1000
PRO_DURATION_DAYS=30
STARS_TEST_MODE=false
```

**Примечание:** Дневной лимит для бесплатных пользователей настраивается через переменную `DAILY_TARGET` в секции Rate Limiting Configuration.

### Telegram Stars

Платежи принимаются только через Telegram Stars - нативную валюту Telegram. Никаких дополнительных токенов не требуется.

### Создание директории для базы данных

```bash
sudo mkdir -p /var/data
sudo chown $USER:$USER /var/data
```

## Команды

### `/buy`
- Показывает варианты оплаты Pro доступа через Telegram Stars
- Создает инвойс с пустым provider_token для Stars

### `/profile`
- Отображает статус пользователя
- Показывает оставшиеся запросы (для free пользователей)
- Показывает дату окончания Pro подписки

## Логика работы

### Бесплатные пользователи
- Лимит: 30 запросов в день (настраивается)
- Счетчик сбрасывается каждый день
- При исчерпании лимита показывается paywall

### Pro пользователи
- Безлимитные запросы
- Подписка действует 30 дней (настраивается)
- Автоматическое понижение до free после истечения

### Paywall
- Появляется при исчерпании дневного лимита
- Предлагает купить Pro доступ
- Показывает кнопки для покупки и просмотра профиля

## Обслуживание

### Очистка истекших подписок

Запустите скрипт для понижения истекших Pro пользователей:

```bash
python scripts/cleanup_subscriptions.py
```

Рекомендуется запускать ежедневно через cron:

```bash
# Автоматическая очистка интегрирована в бота
# Очистка истекших подписок выполняется автоматически каждый день в полночь UTC
# Дополнительная настройка не требуется

# Для ручного запуска очистки (только для администратора):
# /cleanup - команда для ручной очистки истекших подписок
```

### Мониторинг

Логи содержат информацию о:
- Успешных платежах
- Обновлениях статуса пользователей
- Ошибках платежей

## Безопасность

- Все платежи проходят через Telegram Stars
- Никаких внешних платежных провайдеров не используется
- База данных должна быть защищена от несанкционированного доступа

## Тестирование

### Тестовый режим Telegram Stars

Для тестирования платежей в разработке установите:

```bash
STARS_TEST_MODE=true
```

**В тестовом режиме:**
- Используются тестовые Telegram Stars (настраивается через @BotFather)
- Платежи не списывают реальные деньги
- В интерфейсе отображается предупреждение о тестовом режиме
- Логи показывают режим работы
- Тестовый режим контролируется через @BotFather, а не через код

**Для продакшена:**
```bash
STARS_TEST_MODE=false
```

### Получение тестовых Stars

1. Обратитесь к @BotFather
2. Выберите вашего бота
3. Выберите "Payments"
4. Выберите "Test Stars"
5. Получите тестовые Stars для тестирования

### Настройка тестового режима

Тестовый режим Telegram Stars настраивается через @BotFather:

1. Обратитесь к @BotFather
2. Выберите вашего бота
3. Выберите "Payments"
4. Выберите "Test Mode" для включения тестового режима
5. В тестовом режиме все платежи используют тестовые Stars

**Важно:** Переменная `STARS_TEST_MODE` в коде используется только для отображения предупреждений в интерфейсе и логирования. Реальный тестовый режим контролируется через @BotFather.
