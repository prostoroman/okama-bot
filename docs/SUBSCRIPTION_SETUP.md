# Настройка платной подписки

## Обзор

Бот теперь поддерживает платную подписку Pro с безлимитным доступом к функциям. Бесплатные пользователи ограничены 30 запросами в день (настраивается).

## Компоненты

### 1. База данных (`services/db.py`)
- SQLite база данных для хранения пользователей и подписок
- Таблица `users` с полями: `user_id`, `plan`, `requests_today`, `last_request`, `paid_until`
- Функции: `init_db()`, `ensure_user()`, `can_use()`, `upgrade_to_pro()`

### 2. Сервис платежей (`services/payment_service.py`)
- Обработка платежей через Telegram Stars
- Создание инвойсов и обработка успешных платежей
- Команды `/buy` и `/profile`

### 3. Обновленный rate limiter (`services/rate_limiter.py`)
- Проверка Pro статуса перед применением лимитов
- Paywall для пользователей с исчерпанным лимитом
- Автоматическое обновление счетчика запросов

## Настройка

### Переменные окружения

Добавьте в `config.env`:

```bash
# Subscription and Payment Configuration
SUBSCRIPTION_DB_PATH=/var/data/bot.db
PRO_PRICE_STARS=1000
PRO_DURATION_DAYS=30
```

**Примечание:** Дневной лимит для бесплатных пользователей настраивается через переменную `DAILY_TARGET` в секции Rate Limiting Configuration.

### Telegram Stars

Платежи принимаются только через Telegram Stars - нативную валюту Telegram. Никаких дополнительных токенов не требуется.

### Создание директории для базы данных

```bash
sudo mkdir -p /var/data
sudo chown $USER:$USER /var/data
```

## Команды

### `/buy`
- Показывает варианты оплаты Pro доступа через Telegram Stars
- Создает инвойс с пустым provider_token для Stars

### `/profile`
- Отображает статус пользователя
- Показывает оставшиеся запросы (для free пользователей)
- Показывает дату окончания Pro подписки

## Логика работы

### Бесплатные пользователи
- Лимит: 30 запросов в день (настраивается)
- Счетчик сбрасывается каждый день
- При исчерпании лимита показывается paywall

### Pro пользователи
- Безлимитные запросы
- Подписка действует 30 дней (настраивается)
- Автоматическое понижение до free после истечения

### Paywall
- Появляется при исчерпании дневного лимита
- Предлагает купить Pro доступ
- Показывает кнопки для покупки и просмотра профиля

## Обслуживание

### Очистка истекших подписок

Запустите скрипт для понижения истекших Pro пользователей:

```bash
python scripts/cleanup_subscriptions.py
```

Рекомендуется запускать ежедневно через cron:

```bash
# Добавьте в crontab
0 0 * * * cd /path/to/bot && python scripts/cleanup_subscriptions.py
```

### Мониторинг

Логи содержат информацию о:
- Успешных платежах
- Обновлениях статуса пользователей
- Ошибках платежей

## Безопасность

- Все платежи проходят через Telegram Stars
- Никаких внешних платежных провайдеров не используется
- База данных должна быть защищена от несанкционированного доступа

## Тестирование

Для тестирования платежей используйте тестовый режим Telegram:
- Установите `TEST_MODE=true` в переменных окружения
- Используйте тестовые Telegram Stars для проверки
