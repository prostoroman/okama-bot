# Реализация интерполяции сплайнами для графиков

## Обзор

Добавлена интерполяция сплайнами для всех линейных графиков в боте, что делает линии графиков плавными вместо ломаных. Также централизованы все настройки стилей графиков для единообразного внешнего вида.

## Основные изменения

### 1. Новый модуль `services/chart_styles.py`

Создан централизованный модуль для управления стилями графиков с:

- **Интерполяцией сплайнами**: Использует `scipy.interpolate.make_interp_spline` для сглаживания линий
- **Едиными настройками стилей**: Все параметры графиков (цвета, шрифты, размеры) в одном месте
- **Централизованным копирайтом**: Единый формат копирайта для всех графиков
- **Оптимизацией памяти**: Автоматическая очистка matplotlib объектов

#### Ключевые методы:

```python
# Сглаживание данных сплайнами
chart_styles.smooth_line_data(x_data, y_data, n_points=1000)

# Рисование сглаженной линии
chart_styles.plot_smooth_line(ax, x_data, y_data, **kwargs)

# Применение базового стиля
chart_styles.apply_base_style(fig, ax)

# Добавление копирайта
chart_styles.add_copyright(ax)
```

### 2. Обновленные файлы

#### `bot.py`
- ✅ `_create_drawdowns_chart()` - интерполяция сплайнами для drawdowns
- ✅ `_create_dividend_yield_chart()` - интерполяция сплайнами для дивидендов
- ✅ `_create_correlation_matrix()` - централизованные стили
- ✅ `compare_command()` - интерполяция сплайнами для сравнения активов
- ✅ `portfolio_command()` - интерполяция сплайнами для портфеля

#### `services/asset_service.py`
- ✅ `create_price_chart()` - интерполяция сплайнами для ценовых графиков

#### `services/report_builder_enhanced.py`
- ✅ Все методы создания графиков используют централизованные стили

### 3. Обновленные зависимости

Добавлена зависимость `scipy>=1.10.0` в `requirements.txt` для интерполяции сплайнами.

## Технические детали

### Интерполяция сплайнами

```python
def smooth_line_data(self, x_data, y_data, n_points=None):
    """
    Сгладить данные линии с помощью интерполяции сплайнами
    
    Args:
        x_data: массив x-координат
        y_data: массив y-координат
        n_points: количество точек для интерполяции (по умолчанию 1000)
        
    Returns:
        tuple: (x_smooth, y_smooth) - сглаженные данные
    """
```

**Алгоритм:**
1. Проверка достаточности данных (минимум 3 точки)
2. Удаление NaN значений
3. Сортировка по x-координатам
4. Удаление дублирующихся x-координат
5. Создание сплайна степени 3 (кубический)
6. Генерация новых точек с заданным разрешением

### Настройки стилей

Все настройки централизованы в классе `ChartStyles`:

```python
# Цвета
self.colors = {
    'primary': '#1f77b4',      # Синий
    'secondary': '#ff7f0e',    # Оранжевый
    'success': '#2ca02c',      # Зеленый
    # ... и другие
}

# Стили
self.style_config = {
    'style': 'fivethirtyeight',
    'figsize': (14, 9),
    'dpi': 150,
    # ... и другие
}

# Настройки линий
self.line_config = {
    'linewidth': 2.5,
    'alpha': 0.9,
    'smooth_points': 1000
}
```

## Преимущества

### 1. Визуальные улучшения
- **Плавные линии**: Убраны острые углы и ломаные линии
- **Профессиональный вид**: Графики выглядят более качественно
- **Лучшая читаемость**: Сглаженные линии легче анализировать

### 2. Технические улучшения
- **Централизация**: Все стили в одном месте
- **Консистентность**: Единый внешний вид всех графиков
- **Легкость поддержки**: Изменения стилей в одном файле
- **Оптимизация памяти**: Автоматическая очистка matplotlib объектов

### 3. Гибкость
- **Настраиваемое разрешение**: Количество точек интерполяции
- **Fallback**: При ошибках интерполяции используется оригинальная линия
- **Расширяемость**: Легко добавлять новые стили и цвета

## Тестирование

Создан тестовый файл `test_spline_interpolation.py` для проверки:

1. **Интерполяции сплайнами**: Сравнение оригинальной и сглаженной линий
2. **Множественных линий**: Тест разных цветов и стилей
3. **Конфигурации стилей**: Проверка всех настроек

### Запуск тестов:

```bash
python test_spline_interpolation.py
```

## Примеры использования

### Базовое использование:

```python
from services.chart_styles import chart_styles

# Создание графика
fig, ax = chart_styles.create_figure()

# Применение стиля
chart_styles.apply_base_style(fig, ax)

# Рисование сглаженной линии
chart_styles.plot_smooth_line(ax, x_data, y_data, label='Актив')

# Добавление копирайта
chart_styles.add_copyright(ax)

# Сохранение
chart_styles.save_figure(fig, output_buffer)
chart_styles.cleanup_figure(fig)
```

### Настройка параметров:

```python
# Изменение количества точек интерполяции
x_smooth, y_smooth = chart_styles.smooth_line_data(x_data, y_data, n_points=2000)

# Получение цвета по индексу
color = chart_styles.get_color(0)  # Первый цвет из палитры

# Применение пользовательских настроек
chart_styles.plot_smooth_line(ax, x_data, y_data, 
                             color='red', linewidth=3, alpha=0.8)
```

## Совместимость

- **Python**: 3.7+
- **matplotlib**: 3.7.0+
- **scipy**: 1.10.0+
- **pandas**: 2.0.0+
- **numpy**: 1.24.0+

## Заключение

Реализация интерполяции сплайнами значительно улучшает качество визуализации графиков, делая их более профессиональными и читаемыми. Централизация стилей упрощает поддержку и обеспечивает единообразие всех графиков в боте.

Все линейные графики теперь автоматически используют интерполяцию сплайнами, что устраняет острые углы и делает линии плавными. При этом сохранена производительность и добавлена обработка ошибок для надежности.
