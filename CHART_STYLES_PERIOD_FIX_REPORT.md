# –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º —Å Period –æ–±—ä–µ–∫—Ç–∞–º–∏ –≤ chart_styles.py

## üéØ –û–±–∑–æ—Ä –ø—Ä–æ–±–ª–µ–º—ã

–ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã `/info sber.moex` –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞ "int too big to convert" –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫—Ä—É–≥–ª–µ–Ω–Ω—ã—Ö –ª–∏–Ω–∏–π –≥—Ä–∞—Ñ–∏–∫–æ–≤. –ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ —Å–≤—è–∑–∞–Ω–∞ —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π `pandas.Period` –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –º–µ—Ç–æ–¥–µ `smooth_line_data`.

## üêõ –ü—Ä–∏—á–∏–Ω–∞ –æ—à–∏–±–∫–∏

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. **Period –æ–±—ä–µ–∫—Ç—ã –≤ –∏–Ω–¥–µ–∫—Å–µ**: Okama library –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å Period –∏–Ω–¥–µ–∫—Å–æ–º –¥–ª—è —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –∞–∫—Ü–∏–π
2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤ —Å–ø–ª–∞–π–Ω–∞—Ö**: –ú–µ—Ç–æ–¥ `smooth_line_data` –ø—ã—Ç–∞–ª—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Period –æ–±—ä–µ–∫—Ç—ã –≤ numpy –æ–ø–µ—Ä–∞—Ü–∏—è—Ö
3. **–û—à–∏–±–∫–∞ –≤ np.linspace**: `x_unique.min()` –∏ `x_unique.max()` –¥–ª—è Period –æ–±—ä–µ–∫—Ç–æ–≤ –≤—ã–∑—ã–≤–∞–ª–∏ –æ—à–∏–±–∫—É "int too big to convert"
4. **–ü—Ä–æ–±–ª–µ–º—ã —Å –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–µ–π –¥–∞—Ç**: –ü–æ–ø—ã—Ç–∫–∞ –∏–Ω—Ç–µ—Ä–ø–æ–ª–∏—Ä–æ–≤–∞—Ç—å Period –æ–±—ä–µ–∫—Ç—ã –ø—Ä–∏–≤–æ–¥–∏–ª–∞ –∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º –æ—à–∏–±–∫–∞–º

### –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –º–µ—Å—Ç–∞ –≤ –∫–æ–¥–µ:

```python
# –°—Ç—Ä–æ–∫–∞ 190 - –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ Period.min() –∏ Period.max()
x_smooth = np.linspace(x_unique.min(), x_unique.max(), n_points)

# –°—Ç—Ä–æ–∫–∞ 200 - –ø—Ä–æ–±–ª–µ–º—ã —Å –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–µ–π Period –æ–±—ä–µ–∫—Ç–æ–≤
date_interp = interp1d(x_numeric, x_valid, kind='linear', ...)
```

## üîß –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ Period –æ–±—ä–µ–∫—Ç–æ–≤

**–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ –Ω–∞—á–∞–ª–µ `smooth_line_data`:**

```python
# –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ Period –æ–±—ä–µ–∫—Ç–æ–≤ –≤ x_data
if hasattr(x_data, 'dtype') and str(x_data.dtype).startswith('period'):
    logger.info("Detected Period dtype, using numeric indices for safe processing")
    # –î–ª—è Period –æ–±—ä–µ–∫—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º —á–∏—Å–ª–æ–≤—ã–µ –∏–Ω–¥–µ–∫—Å—ã
    x_data = np.arange(len(x_data))
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Period –æ–±—ä–µ–∫—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –≤ —á–∏—Å–ª–æ–≤—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏.

### 2. –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö

**–†–∞—Å—à–∏—Ä–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è Period –æ–±—ä–µ–∫—Ç–æ–≤:**

```python
# –î–ª—è Period –æ–±—ä–µ–∫—Ç–æ–≤ –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —á–∏—Å–ª–æ–≤—ã–µ –∏–Ω–¥–µ–∫—Å—ã
if hasattr(x_valid, 'dtype') and (x_valid.dtype.kind in ['M', 'O'] or str(x_valid.dtype).startswith('period')):
    # –î–ª—è datetime, object –∏–ª–∏ period —Ç–∏–ø–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º —á–∏—Å–ª–æ–≤—ã–µ –∏–Ω–¥–µ–∫—Å—ã
    x_numeric = np.arange(len(x_valid))
    use_numeric_x = True
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Period –æ–±—ä–µ–∫—Ç—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–∞–∫ —á–∏—Å–ª–æ–≤—ã–µ –∏–Ω–¥–µ–∫—Å—ã.

### 3. –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è x_smooth

**–î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫ –≤ np.linspace:**

```python
# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ —Ç–æ—á–∫–∏ - –±–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º Period –æ–±—ä–µ–∫—Ç—ã
try:
    if hasattr(x_unique, 'min') and hasattr(x_unique, 'max'):
        x_min = x_unique.min()
        x_max = x_unique.max()
        
        # –ë–µ–∑–æ–ø–∞—Å–Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Period –æ–±—ä–µ–∫—Ç—ã
        if hasattr(x_min, 'to_timestamp'):
            x_min = x_min.to_timestamp()
        if hasattr(x_max, 'to_timestamp'):
            x_max = x_max.to_timestamp()
        
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ float –¥–ª—è np.linspace
        x_min_float = float(x_min)
        x_max_float = float(x_max)
        
        x_smooth = np.linspace(x_min_float, x_max_float, n_points)
    else:
        # Fallback –¥–ª—è —Å–ª—É—á–∞–µ–≤ –±–µ–∑ min/max –º–µ—Ç–æ–¥–æ–≤
        x_smooth = np.linspace(0, len(x_unique) - 1, n_points)
        x_smooth = x_unique[0] + (x_unique[-1] - x_unique[0]) * x_smooth / (len(x_unique) - 1)
except Exception as e:
    logger.warning(f"Error in x_smooth generation: {e}, using fallback")
    x_smooth = np.linspace(0, len(x_unique) - 1, n_points)
    x_smooth = x_unique[0] + (x_unique[-1] - x_unique[0]) * x_smooth / (len(x_unique) - 1)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ—á–µ–∫ –¥–ª—è —Å–ø–ª–∞–π–Ω–æ–≤ —Å fallback –º–µ—Ç–æ–¥–∞–º–∏.

### 4. –£–ª—É—á—à–µ–Ω–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –¥–∞—Ç

**–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è Period –≤ timestamp:**

```python
# –ë–µ–∑–æ–ø–∞—Å–Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Period –æ–±—ä–µ–∫—Ç—ã –≤ timestamp
x_valid_timestamps = []
for x_val in x_valid:
    if hasattr(x_val, 'to_timestamp'):
        timestamp = x_val.to_timestamp()
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º timestamp –≤ float –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏
        if hasattr(timestamp, 'timestamp'):
            x_valid_timestamps.append(timestamp.timestamp())
        else:
            x_valid_timestamps.append(float(timestamp))
    else:
        x_valid_timestamps.append(x_val)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –¥–∞—Ç –±–µ–∑ –æ—à–∏–±–æ–∫ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏.

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç `test_chart_styles_fix.py`:

- **–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ**: Period –∏–Ω–¥–µ–∫—Å —Å 366 —Ç–æ—á–∫–∞–º–∏ (–∏–º–∏—Ç–∞—Ü–∏—è SBER.MOEX)
- **–¢–µ—Å—Ç–∏—Ä—É–µ–º—ã–µ –º–µ—Ç–æ–¥—ã**: `smooth_line_data`, `plot_smooth_line`
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ

### –õ–æ–≥–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

```
üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º smooth_line_data...
2025-08-30 16:11:41,846 - INFO - Detected Period dtype, using numeric indices for safe processing
‚úÖ smooth_line_data —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω:
   - x_smooth —Ç–∏–ø: <class 'numpy.ndarray'>
   - y_smooth —Ç–∏–ø: <class 'numpy.ndarray'>
   - x_smooth –¥–ª–∏–Ω–∞: 3000
   - y_smooth –¥–ª–∏–Ω–∞: 3000

üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º plot_smooth_line...
2025-08-30 16:11:42,164 - INFO - Detected Period dtype, using numeric indices for safe processing
‚úÖ plot_smooth_line —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω:
   - –õ–∏–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∞: Line2D(_child0)
```

## üìÅ –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã

- **`services/chart_styles.py`** - –æ—Å–Ω–æ–≤–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –º–µ—Ç–æ–¥–∞—Ö `smooth_line_data` –∏ `plot_smooth_line`

## üöÄ –†–µ–∑—É–ª—å—Ç–∞—Ç

### ‚úÖ –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:

1. **–û—à–∏–±–∫–∞ "int too big to convert"** - –ø–æ–ª–Ω–æ—Å—Ç—å—é —É—Å—Ç—Ä–∞–Ω–µ–Ω–∞
2. **–ü—Ä–æ–±–ª–µ–º—ã —Å Period –æ–±—ä–µ–∫—Ç–∞–º–∏** - —Ä–µ—à–µ–Ω—ã —á–µ—Ä–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —á–∏—Å–ª–æ–≤—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤
3. **–°–∫—Ä—É–≥–ª–µ–Ω–∏–µ –ª–∏–Ω–∏–π** - —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
4. **Fallback –º–µ—Ç–æ–¥—ã** - –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏

### üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è:

- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ** Period –æ–±—ä–µ–∫—Ç–æ–≤
- **–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è** –≤ —á–∏—Å–ª–æ–≤—ã–µ –∏–Ω–¥–µ–∫—Å—ã
- **–£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** —Å fallback –º–µ—Ç–æ–¥–∞–º–∏
- **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

## üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã `/info sber.moex`** - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≥—Ä–∞—Ñ–∏–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã `/portfolio`** - —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ Period –æ–±—ä–µ–∫—Ç—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - —Å–ª–µ–¥–∏—Ç—å –∑–∞ –ª–æ–≥–∞–º–∏ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –Ω–æ–≤—ã—Ö –æ—à–∏–±–æ–∫

## üéâ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü—Ä–æ–±–ª–µ–º—ã —Å Period –æ–±—ä–µ–∫—Ç–∞–º–∏ –≤ `chart_styles.py` —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã. –¢–µ–ø–µ—Ä—å —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ –ª–∏–Ω–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö, –≤–∫–ª—é—á–∞—è —Ä–æ—Å—Å–∏–π—Å–∫–∏–µ –∞–∫—Ü–∏–∏ —Å Period –∏–Ω–¥–µ–∫—Å–∞–º–∏. –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –Ω–∞ GitHub.
